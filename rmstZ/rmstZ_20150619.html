<!DOCTYPE html><html><head><meta http-equiv="Content-Type"content="text/html;charset=utf-8"/><style type="text/css">#divRoot{text-align:center;}#divTitle{clear:both;text-align:center;margin:16px;}#divOperateBin{text-align:center;margin:3px;display:none;}#divOperateXml{text-align:center;margin:3px;display:none;}#divOperateImd{text-align:center;margin:3px;display:none;}#divSelectImd{text-align:center;margin:3px;display:none;}#divSelectTxt{text-align:center;margin:3px;display:none;}#divSelectBms{text-align:center;margin:3px;display:none;}#divOperateImg{text-align:center;margin:3px;display:none;}#divSave{text-align:center;margin:3px;display:none;}#divResult{margin:16px;}#divCopyright{clear:both;text-align:center;margin:16px;}</style></head><body><div id="divRoot"><div id="divTitle">rmstZ</div><div id="divFileReader"><input type="file"accept=".bin,.xml,.mde,.imd,.txt,.bms,.bme,.pms,.bmp,.jpg,.gif,.png,.mp3,"onchange="ReadFile(event)"/></div><div id="divOperate"><div id="divOperateBin"><select id="selectBinMode"onchange="SelectChanged()"><option value="xml"selected="selected">xml</option><option value="html">html</option></select></div><div id="divOperateXml"><select id="selectXmlbinMode"onchange="SelectChanged()"><option value="bin"selected="selected">bin</option><option value="html">html</option></select></div><div id="divOperateImd"><div id="divSelectImd"><select id="selectImdMode"onchange="SelectChanged()"><option value="imd">imd</option><option value="txt">txt</option><option value="bms">bms</option><option value="png"selected="selected">png</option><option value="html">html</option></select></div><div id="divOptionImd1"><input type="checkbox"id="inputDrawBackground"checked="checked"onchange="OptionChanged()">背景色</input><input type="checkbox"id="inputDrawTrack"checked="checked"onchange="OptionChanged()">轨道线</input><input type="checkbox"id="inputDrawFrame"checked="checked"onchange="OptionChanged()">边框线</input></div><div id="divOptionImd2"><input type="checkbox"id="inputDrawBeat"checked="checked"onchange="OptionChanged()">节拍线</input><input type="checkbox"id="inputDrawCombo"checked="checked"onchange="OptionChanged()">连击数</input><input type="checkbox"id="inputDrawDetermine"checked="checked"onchange="OptionChanged()">判定线</input></div><div id="divOptionImd3"><select id="selectImdScaleX"onchange="OptionChanged()"><option value="1"selected="selected">128px</option><option value="2.5">320px</option><option value="5">640px</option><option value="7.5">960px</option></select><select id="selectImdScaleY"onchange="OptionChanged()"><option value="1">X1</option><option value="2">X2</option><option value="3">X3</option><option value="4"selected="selected">X4</option></select></div><div id="divOptionImd4"><input type="checkbox"id="inputExcludeBug"checked="checked"onchange="CheckChanged()">去除Bug</input><input type="checkbox"id="inputLimit6Key"onchange="CheckChanged()">限制6K</input></div><div id="divOptionImd5"><input type="checkbox"id="inputNoSlideKey"onchange="CheckChanged()">无滑键</input><input type="checkbox"id="inputAllSingleKey"onchange="CheckChanged()">全单键</input></div></div><div id="divOperateImg"><select id="selectImgMode"onchange="SelectChanged()"><option value="480×320"selected="selected">*.png</option><option value="140×60">*_title_ipad.png</option><option value="1024×768">*_ipad.png</option><option value="140×90">*_title_140_90.png</option></select></div></div><div id="divSave"><a id="aSave">保存</a></div><div id="divResult"></div><div id="divCopyright">Copyright © 心のsky Group</div></div><script type="text/javascript">var LittleEndian=(function(){var b=new ArrayBuffer(2);new DataView(b).setInt16(0,1,true);return new Int16Array(b)[0]===1;})();var SupportFileAPI=(function(){return!(typeof(window.File&&window.FileReader&&window.FileList&&window.Blob)==="undefined");})();var SupportCanvasAPI=(function(){return!(typeof document.createElement('canvas').getContext==="undefined");})();var SupportAudioAPI=(function(){return!(typeof(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContex)==="undefined");})();var IsUCBrowser=(function(){return(navigator.userAgent.indexOf("UCBrowser")!=-1);})();function GetFileName(n){var i=n.lastIndexOf(".");if(i!=-1){return n.substring(0,i);}
else{return"";}}
function GetFileExtension(n){var i=n.lastIndexOf(".");if(i!=-1){return n.substring(i+1).toLowerCase();}
else{return"";}}
function GetFileType(e,b){var r="";switch(e){case"xml":if(b.length>=37){switch(b[36]){case 0x20:r="bin";break;case 0x3F:r="mde";break;}}
break;default:r="";}
return r;}
function GetSelectValue(id){var s=document.getElementById(id);return s.options[s.selectedIndex].value;}
function OptimizeName(n){var r=n;var l1;var l2;while(true){l1=r.lastIndexOf("(");l2=r.lastIndexOf(")");if((l1!=-1)&&(l2!=-1)&&(l1<l2)&&!(isNaN(parseInt(r.substring(l1+1,l2))))){r=r.substring(0,l1).trim();}
else{break;}}
return r;}
function GetBinName(u){var r=[];var BinUnit=new Array(["errno_main_client",564],["mrock.active_client",35],["mrock.character_client",644],["mrock.characterproperty_client",327],["mrock.floornode_client",16],["mrock.floorreward_client",186],["mrock.innerpublicnotify_client",928],["mrock.innerrace_client",616],["mrock.luckyturntablereward_client",18],["mrock.luckyturntabletypeshow_client",137],["mrock.marketact_client",152],["mrock.mission_client",414],["mrock.scorebuy_client",22],["mrock.scoreexchange_client",21],["mrock.surviveact_client",263],["mrock.thingbuy_client",31],["mrock.timelimitcharacter_client",284],["mrock_buynew_client",295],["mrock_dailyactive_client",105],["mrock_guild_song_client",28],["mrock_guildactivity_client",332],["mrock_Map_client",57],["mrock_match_client",4156],["mrock_match_division_client",260],["mrock_medal_client",92],["mrock_noble_client",3993],["mrock_noble_gift_client",304],["mrock_papasong_client",361],["mrock_questconfig_client",640],["errno_main_client",564],["mrock_recharge_ios_client",406],["mrock_recharge_android_client",406],["mrock_room_client",24],["mrock_scoreexchange_client",21],["mrock_share_client",268],["mrock_song_client",830],["mrock_song_client_android",830],["mrock_songlevel_client",830],["mrock_SongPkg_client",808],["mrock_starmall_exchange_client",93],["mrock_SysParam_client",8],["mrock_txt_client",260]);for(var i=0;i<BinUnit.length;i++){if(BinUnit[i][1]==u){r.push(BinUnit[i][0]);}}
return r;}
function GetBinStructure(){var r=[];switch(FileName){case"errno_main_client":r.push(new Array(0,"m_szName",48));r.push(new Array(0,"m_uiValue",4));r.push(new Array(0,"m_szDescriptionZH",256));r.push(new Array(0,"m_szDescriptionEN",256));r=new Array("ErrnoConfig_Client_Tab","ErrnoConfig_Client",r);break;case"mrock.active_client":r.push(new Array(0,"m_ushActiveID",2));r.push(new Array(0,"m_ucActiveType",1));r.push(new Array(0,"m_iNumber",4));r.push(new Array(0,"m_ucRewardNumber",1));r.push(new Array(1,"m_astReward,ActiveReward",3));r=new Array("ActiveConfig_Client_Tab","ActiveConfig_Client",r);break;case"mrock.character_client":r.push(new Array(0,"m_usID",2));r.push(new Array(0,"m_usIconID",2));r.push(new Array(0,"m_szDesc",256));r.push(new Array(0,"m_szNoteDesc",256));r.push(new Array(0,"m_szNoteStyle1",32));r.push(new Array(0,"m_szNoteStyle2",32));r.push(new Array(0,"m_szNoteStyle3",32));r.push(new Array(0,"m_szGameSpeaking",32));r=new Array("CharacterConfig_Client_Tab","CharacterConfig_Client",r);break;case"mrock.characterproperty_client":r.push(new Array(0,"m_usID",2));r.push(new Array(0,"m_ucPropertyID",1));r.push(new Array(0,"m_ucType",1));r.push(new Array(0,"m_usIconID",2));r.push(new Array(0,"m_ucEffectType",1));r.push(new Array(0,"m_szName",32));r.push(new Array(0,"m_szEffect",32));r.push(new Array(0,"m_szDesc",256));r=new Array("CharacterPropertyConfig_Client_Tab","CharacterPropertyConfig_Client",r);break;case"mrock.floornode_client":r.push(new Array(0,"m_iNodeID",4));r.push(new Array(0,"m_iNodeType",4));r.push(new Array(0,"m_iNodeValue",4));r.push(new Array(0,"m_iPlayStyle",4));r=new Array("FloorNodeConfig_Client_Tab","FloorNodeConfig_Client",r);break;case"mrock.floorreward_client":r.push(new Array(0,"m_iRewardID",4));r.push(new Array(0,"m_ucRewardType",1));r.push(new Array(0,"m_iRewardValue",4));r=new Array("FloorRewardConfig_Client_Tab","FloorRewardConfig_Client",r);break;case"mrock.innerpublicnotify_client":r.push(new Array(0,"m_iID",4));r.push(new Array(0,"m_iLevel",4));r.push(new Array(0,"m_iLinkType",4));r.push(new Array(0,"m_iContentType",4));r.push(new Array(0,"m_szTitle",300));r.push(new Array(0,"m_szContent",300));r.push(new Array(0,"m_szUrl",300));r.push(new Array(0,"m_iForce",4));r.push(new Array(0,"m_iPhonetype",4));r.push(new Array(0,"m_iLoginType",4));r=new Array("InnerPublicNotifyConfig_Client_Tab","InnerPublicNotifyConfig_Client",r);break;case"mrock.innerrace_client":r.push(new Array(0,"m_iMatchID",4));r.push(new Array(0,"m_iLevel",4));r.push(new Array(0,"m_iContentType",4));r.push(new Array(0,"m_szTitle",300));r.push(new Array(0,"m_szContent",300));r.push(new Array(0,"m_iPhonetype",4));r=new Array("InnerRaceConfig_Client_Tab","InnerRaceConfig_Client",r);break;case"mrock.luckyturntablereward_client":break;case"mrock.luckyturntabletypeshow_client":break;case"mrock.marketact_client":r.push(new Array(0,"m_ushMarketActID",2));r.push(new Array(0,"m_szDescription",128));r.push(new Array(0,"m_ucRewardNumber",1));r.push(new Array(1,"m_astReward,MarketActReward",3));r=new Array("MarketActConfig_Client_Tab","MarketActConfig_Client",r);break;case"mrock.mission_client":r.push(new Array(0,"m_iMissionID",4));r.push(new Array(0,"m_szTitle",128));r.push(new Array(0,"m_iIconID",4));r.push(new Array(0,"m_szDiffDesc",64));r.push(new Array(0,"m_szDiffColor",64));r.push(new Array(0,"m_szBeginTime",64));r.push(new Array(0,"m_szEndTime",64));r.push(new Array(0,"m_iStartFloor",4));r.push(new Array(0,"m_iEndFloor",4));r.push(new Array(0,"m_ucResetable",4));r.push(new Array(0,"m_iResetCost",4));r.push(new Array(0,"m_ucRewardType",1));r.push(new Array(0,"m_ucIsNew",1));r.push(new Array(0,"m_iSeqID",4));r=new Array("MissionConfig_Client_Tab","MissionConfig_Client",r);break;case"mrock.scorebuy_client":r.push(new Array(0,"m_iBuyID",4));r.push(new Array(0,"m_ucItemType",1));r.push(new Array(0,"m_iItemID",4));r.push(new Array(0,"m_iItemValue",4));r.push(new Array(0,"m_iScorePresent",4));r.push(new Array(0,"m_ucBuyType",1));r.push(new Array(0,"m_iCostNum",4));r=new Array("ScoreBuyConfig_Client_Tab","ScoreBuyConfig_Client",r);break;case"mrock.scoreexchange_client":case"mrock_scoreexchange_client":r.push(new Array(0,"m_iExchangeID",4));r.push(new Array(0,"m_ucItemType",1));r.push(new Array(0,"m_iItemID",4));r.push(new Array(0,"m_iItemValue",4));r.push(new Array(0,"m_iScoreCost",4));r.push(new Array(0,"m_iVersion",4));r=new Array("ScoreExchangeConfig_Client_Tab","ScoreExchangeConfig_Client",r);break;case"mrock.surviveact_client":r.push(new Array(0,"m_iID",4));r.push(new Array(0,"m_ushSongID",2));r.push(new Array(0,"m_ucNoteType",1));r.push(new Array(0,"m_szOpenTimeDesc",256));r=new Array("SurviveActConfig_Client_Tab","SurviveActConfig_Client",r);break;case"mrock.thingbuy_client":break;case"mrock.timelimitcharacter_client":r.push(new Array(0,"m_ushID",2));r.push(new Array(0,"m_ushCharacterID",2));r.push(new Array(0,"m_ushInitLevel",2));r.push(new Array(0,"m_szName",22));r.push(new Array(0,"m_szDesc",256));r=new Array("TimeLimitCharacterConfig_Client_Tab","TimeLimitCharacterConfig_Client",r);break;case"mrock_buynew_client":r.push(new Array(0,"m_ushID",2));r.push(new Array(0,"m_ucType",1));r.push(new Array(0,"m_iThingID",4));r.push(new Array(0,"m_szItemName",128));r.push(new Array(0,"m_iThingNumber",4));r.push(new Array(0,"m_iIOSMoney",4));r.push(new Array(0,"m_iAndroidMoney",4));r.push(new Array(0,"m_iDiamonds",4));r.push(new Array(0,"m_szDescriptionName",128));r.push(new Array(0,"m_iIconID",4));r.push(new Array(0,"m_iIsopen",4));r.push(new Array(0,"m_iSequence",4));r.push(new Array(0,"m_iIsone",4));r=new Array("BuyConfig_Client_Tab","BuyConfig_Client",r);break;case"mrock_dailyactive_client":break;case"mrock_guild_song_client":break;case"mrock_guildactivity_client":break;case"mrock_Map_client":break;case"mrock_match_client":r.push(new Array(0,"m_iMatchIndex",4));r.push(new Array(0,"m_iRegion",4));r.push(new Array(0,"m_iType",4));r.push(new Array(0,"m_szBeginTime",64));r.push(new Array(0,"m_szEndTime",64));r.push(new Array(0,"m_iElectNumber",4));r.push(new Array(0,"m_iGroupNumber",4));r.push(new Array(0,"m_szApplySuccess",64));r.push(new Array(0,"m_szTitle",64));r.push(new Array(0,"m_szTitle1",64));r.push(new Array(0,"m_szContent1",200));r.push(new Array(0,"m_szTitle2",64));r.push(new Array(0,"m_szContent2",200));r.push(new Array(0,"m_szTitle3",64));r.push(new Array(0,"m_szContent3",1024));r.push(new Array(0,"m_szContentPage201",200));r.push(new Array(0,"m_szContentPage202",200));r.push(new Array(0,"m_szContentPage203",200));r.push(new Array(0,"m_szContentPage204",200));r.push(new Array(0,"m_szContentPage205",200));r.push(new Array(0,"m_szTimeDesc",200));r.push(new Array(0,"m_szPostTitle",64));r.push(new Array(0,"m_szPostDesc1",200));r.push(new Array(0,"m_szPostDesc2",200));r.push(new Array(0,"m_szPostDesc3",200));r.push(new Array(0,"m_szPostDesc4",200));r.push(new Array(0,"m_szStageName",200));r=new Array("MatchConfig_Client_Tab","MatchConfig_Client",r);break;case"mrock_match_division_client":r.push(new Array(0,"m_iMatchID",4));r.push(new Array(0,"m_szFilterSort1",64));r.push(new Array(0,"m_szFilterSort2",64));r.push(new Array(0,"m_szFilter1",64));r.push(new Array(0,"m_szFilter2",64));r=new Array("MatchDivisionConfig_Client_Tab","MatchDivisionConfig_Client",r);break;case"mrock_medal_client":break;case"mrock_noble_client":break;case"mrock_noble_gift_client":break;case"mrock_papasong_client":r.push(new Array(0,"m_ushSongID",2));r.push(new Array(0,"m_iVersion",4));r.push(new Array(0,"m_szSongName",64));r.push(new Array(0,"m_cDifficulty",1));r.push(new Array(0,"m_cLevel",1));r.push(new Array(0,"m_szPath",64));r.push(new Array(0,"m_szArtist",64));r.push(new Array(0,"m_szSongTime",64));r.push(new Array(0,"m_iGameTime",4));r.push(new Array(0,"m_szRegion",20));r.push(new Array(0,"m_szStyle",20));r.push(new Array(0,"m_szBPM",20));r.push(new Array(0,"m_szNoteNumber",20));r.push(new Array(0,"m_iOrderIndex",4));r.push(new Array(0,"m_ucIsOpen",1));r.push(new Array(0,"m_ucIsFree",1));r.push(new Array(0,"m_ucIsHide",1));r.push(new Array(0,"m_ucIsReward",1));r.push(new Array(0,"m_ucIsLevelReward",1));r.push(new Array(0,"m_iSongType",4));r=new Array("PapaSongConfig_Client_Tab","PapaSongConfig_Client",r);break;case"mrock_questconfig_client":r.push(new Array(0,"m_iQuestId",4));r.push(new Array(0,"m_szQuestName",300));r.push(new Array(0,"m_szDescription",300));r.push(new Array(0,"m_iMethod",4));r.push(new Array(0,"m_iNodeType",4));r.push(new Array(0,"m_iNodeValue",4));r.push(new Array(0,"m_iNodeLimit",4));r.push(new Array(0,"m_iSongNodeID",4));r.push(new Array(0,"m_iSongNodeNoteType",4));r.push(new Array(0,"m_iRewardType",4));r.push(new Array(0,"m_iRewardID",4));r.push(new Array(0,"m_iRewardValue",4));r=new Array("QuestConfig_Client_Tab","QuestConfig_Client",r);break;case"mrock_recharge_ios_client":case"mrock_recharge_android_client":break;case"mrock_room_client":r.push(new Array(0,"m_ushRoomID",2));r.push(new Array(0,"m_ucSongType",1));r.push(new Array(0,"m_ucTicketType",1));r.push(new Array(0,"m_iTicketNum",4));r.push(new Array(0,"m_ucRewardType",1));r.push(new Array(0,"m_iRewardNum",4));r.push(new Array(0,"m_iRewardIntergral",4));r.push(new Array(0,"m_ucIsOpen",1));r.push(new Array(0,"m_ucIsNewOpen",1));r.push(new Array(0,"m_ucIsProp",1));r.push(new Array(0,"m_iMinClientVersion",4));r=new Array("RoomConfig_Client_Tab","RoomConfig_Client",r);break;case"mrock_share_client":break;case"mrock_song_client":case"mrock_song_client_android":case"mrock_songlevel_client":r.push(new Array(0,"m_ushSongID",2));r.push(new Array(0,"m_iVersion",4));r.push(new Array(0,"m_szSongName",64));r.push(new Array(0,"m_szPath",64));r.push(new Array(0,"m_szArtist",64));r.push(new Array(0,"m_szComposer",64));r.push(new Array(0,"m_szSongTime",64));r.push(new Array(0,"m_iGameTime",4));r.push(new Array(0,"m_iRegion",4));r.push(new Array(0,"m_iStyle",4));r.push(new Array(0,"m_ucIsNew",2));r.push(new Array(0,"m_ucIsHot",2));r.push(new Array(0,"m_ucIsRecommend",2));r.push(new Array(0,"m_szBPM",64));r.push(new Array(0,"m_ucIsOpen",2));r.push(new Array(0,"m_ucCanBuy",1));r.push(new Array(0,"m_iOrderIndex",4));r.push(new Array(0,"m_bIsFree",1));r.push(new Array(0,"m_bSongPkg",1));r.push(new Array(0,"m_szFreeBeginTime",64));r.push(new Array(0,"m_szFreeEndTime",64));r.push(new Array(0,"m_ush4KeyEasy",2));r.push(new Array(0,"m_ush4KeyNormal",2));r.push(new Array(0,"m_ush4KeyHard",2));r.push(new Array(0,"m_ush5KeyEasy",2));r.push(new Array(0,"m_ush5KeyNormal",2));r.push(new Array(0,"m_ush5KeyHard",2));r.push(new Array(0,"m_ush6KeyEasy",2));r.push(new Array(0,"m_ush6KeyNormal",2));r.push(new Array(0,"m_ush6KeyHard",2));r.push(new Array(0,"m_iPrice",4));r.push(new Array(0,"m_szNoteNumber",128));r.push(new Array(0,"m_szProductID",128));r.push(new Array(0,"m_iVipFlag",4));r.push(new Array(0,"m_bIsHide",1));r.push(new Array(0,"m_bIsReward",1));r.push(new Array(0,"m_bIsLevelReward",1));r=new Array("SongConfig_Client_Tab","SongConfig_Client",r);break;case"mrock_SongPkg_client":r.push(new Array(0,"m_ushIndex",2));r.push(new Array(0,"m_szProductID",128));r.push(new Array(0,"m_szDesc",512));r.push(new Array(0,"m_szPath",128));r.push(new Array(0,"m_iAndroidPrice",4));r.push(new Array(0,"m_iPrice",4));r.push(new Array(0,"m_iEnable",4));r.push(new Array(0,"m_bIsNew",1));r.push(new Array(0,"m_bIsHot",1));r.push(new Array(0,"m_iNum",4));r.push(new Array(1,"m_astSongs,PkgSong",10));r=new Array("SongPkgConfig_Client_Tab","SongPkgConfig_Client",r);break;case"mrock_starmall_exchange_client":break;case"mrock_SysParam_client":r.push(new Array(0,"m_iParamID",4));r.push(new Array(0,"m_iParamValue",4));r=new Array("SysParamConfig_Client_Tab","SysParamConfig_Client",r);break;case"mrock_txt_client":r.push(new Array(0,"m_uiID",4));r.push(new Array(0,"m_szDescriptionZH",256));r=new Array("TxtConfig_Client_Tab","TxtConfig_Client",r);break;}
return r;}
function GetFontSize(f){var r=0;var a=f.split(" ");for(var i=0;i<a.length;i++){if((a[i].length>2)&&(a[i].substring(a[i].length-2,a[i].length)=="px")){var s;try{s=parseInt(a[i].substring(0,a[i].length-2),10);if(isNaN(s)){s=0;}}
catch(e){s=0;}
if(s!=0){r=s;break;}}}
return r;}
function SetFontSize(f,n){var a=f.split(" ");for(var i=0;i<a.length;i++){if((a[i].length>2)&&(a[i].substring(a[i].length-2,a[i].length)=="px")){a[i]=n.toString()+"px";break;}}
return a.join(" ");}
function GetImdOption(){var b=(arguments.length>0)?arguments[0]:true;var r=[];r.push(document.getElementById("inputDrawBackground").checked);r.push(document.getElementById("inputDrawTrack").checked);r.push(document.getElementById("inputDrawFrame").checked);r.push(document.getElementById("inputDrawBeat").checked);r.push(document.getElementById("inputDrawCombo").checked);r.push(document.getElementById("inputDrawDetermine").checked);if(b){r.push(GetSelectValue("selectImdScaleX"));r.push(GetSelectValue("selectImdScaleY"));}
else{r.push("1");r.push("0");}
return r;}
function GetImdCheck(){var r=[];r.push(document.getElementById("inputExcludeBug").checked);r.push(document.getElementById("inputLimit6Key").checked);r.push(document.getElementById("inputNoSlideKey").checked);r.push(document.getElementById("inputAllSingleKey").checked);return r;}
function GetDateTime(){var d=new Date();return d.getFullYear().toString().fill("0",4,true)+"."+(d.getMonth()+1).toString().fill("0",2,true)+"."+d.getDate().toString().fill("0",2,true)+" "+d.getHours().toString().fill("0",2,true)+":"+d.getMinutes().toString().fill("0",2,true)+":"+d.getSeconds().toString().fill("0",2,true);}
function GetImgSelect(){return GetSelectValue("selectImgMode");}
function GetImgSrc(b){if(b.length==0){return"";}
var t;switch(b[0]){case 0x42:t="bmp";break;case 0xFF:t="jpg";break;case 0x47:t="gif";break;case 0x89:t="png";break;}
return"data:image/"+t+";base64,"+BytesToBase64(b);}
function GetImgSize(b){if(b.length==0){return"0×0";}
var img=document.createElement("img");img.style.display="none";img.src=GetImgSrc(b);return img.width.toString()+"×"+img.height.toString();}
function GetMD5(t){var SetArray=function(t){var c;var p;var l=t.length;var n=(((l+8)-((l+8)%64))/64+1)*16;var r=new Int32Array(n-1);var i=0;while(i<l){c=(i-(i%4))/4;p=(i%4)*8;r[c]=(r[c]|(t[i]<<p));i++;}
c=(i-(i%4))/4;p=(i%4)*8;r[c]=r[c]|(0x80<<p);r[n-2]=l<<3;r[n-1]=l>>>29;return r;};var Add=function(X,Y){var r=(X&0x3FFFFFFF)+(Y&0x3FFFFFFF);var X4=(X&0x40000000);var Y4=(Y&0x40000000);var X8=(X&0x80000000);var Y8=(Y&0x80000000);if(X4&Y4){return(r^0x80000000^X8^Y8);}
if(X4|Y4){if(r&0x40000000){return(r^0xC0000000^X8^Y8);}else{return(r^0x40000000^X8^Y8);}}else{return(r^X8^Y8);}};var Rotate=function(t,b){return(t<<b)|(t>>>(32-b));};var F=function(X,Y,Z){return(X&Y)|((~X)&Z);};var G=function(X,Y,Z){return(X&Z)|(Y&(~Z));};var H=function(X,Y,Z){return(X^Y^Z);};var I=function(X,Y,Z){return(Y^(X|(~Z)));};var FF=function(a,b,c,d,m,s,t){a=Add(a,Add(Add(F(b,c,d),m),t));return Add(Rotate(a,s),b);};var GG=function(a,b,c,d,m,s,t){a=Add(a,Add(Add(G(b,c,d),m),t));return Add(Rotate(a,s),b);};var HH=function(a,b,c,d,m,s,t){a=Add(a,Add(Add(H(b,c,d),m),t));return Add(Rotate(a,s),b);};var II=function(a,b,c,d,m,s,t){a=Add(a,Add(Add(I(b,c,d),m),t));return Add(Rotate(a,s),b);};var m=SetArray(t);var A;var B;var C;var D;var a=0x67452301;var b=0xEFCDAB89;var c=0x98BADCFE;var d=0x10325476;for(var i=0;i<m.length;i+=16){A=a;B=b;C=c;D=d;a=FF(a,b,c,d,m[i+0],7,0xD76AA478);d=FF(d,a,b,c,m[i+1],12,0xE8C7B756);c=FF(c,d,a,b,m[i+2],17,0x242070DB);b=FF(b,c,d,a,m[i+3],22,0xC1BDCEEE);a=FF(a,b,c,d,m[i+4],7,0xF57C0FAF);d=FF(d,a,b,c,m[i+5],12,0x4787C62A);c=FF(c,d,a,b,m[i+6],17,0xA8304613);b=FF(b,c,d,a,m[i+7],22,0xFD469501);a=FF(a,b,c,d,m[i+8],7,0x698098D8);d=FF(d,a,b,c,m[i+9],12,0x8B44F7AF);c=FF(c,d,a,b,m[i+10],17,0xFFFF5BB1);b=FF(b,c,d,a,m[i+11],22,0x895CD7BE);a=FF(a,b,c,d,m[i+12],7,0x6B901122);d=FF(d,a,b,c,m[i+13],12,0xFD987193);c=FF(c,d,a,b,m[i+14],17,0xA679438E);b=FF(b,c,d,a,m[i+15],22,0x49B40821);a=GG(a,b,c,d,m[i+1],5,0xF61E2562);d=GG(d,a,b,c,m[i+6],9,0xC040B340);c=GG(c,d,a,b,m[i+11],14,0x265E5A51);b=GG(b,c,d,a,m[i+0],20,0xE9B6C7AA);a=GG(a,b,c,d,m[i+5],5,0xD62F105D);d=GG(d,a,b,c,m[i+10],9,0x2441453);c=GG(c,d,a,b,m[i+15],14,0xD8A1E681);b=GG(b,c,d,a,m[i+4],20,0xE7D3FBC8);a=GG(a,b,c,d,m[i+9],5,0x21E1CDE6);d=GG(d,a,b,c,m[i+14],9,0xC33707D6);c=GG(c,d,a,b,m[i+3],14,0xF4D50D87);b=GG(b,c,d,a,m[i+8],20,0x455A14ED);a=GG(a,b,c,d,m[i+13],5,0xA9E3E905);d=GG(d,a,b,c,m[i+2],9,0xFCEFA3F8);c=GG(c,d,a,b,m[i+7],14,0x676F02D9);b=GG(b,c,d,a,m[i+12],20,0x8D2A4C8A);a=HH(a,b,c,d,m[i+5],4,0xFFFA3942);d=HH(d,a,b,c,m[i+8],11,0x8771F681);c=HH(c,d,a,b,m[i+11],16,0x6D9D6122);b=HH(b,c,d,a,m[i+14],23,0xFDE5380C);a=HH(a,b,c,d,m[i+1],4,0xA4BEEA44);d=HH(d,a,b,c,m[i+4],11,0x4BDECFA9);c=HH(c,d,a,b,m[i+7],16,0xF6BB4B60);b=HH(b,c,d,a,m[i+10],23,0xBEBFBC70);a=HH(a,b,c,d,m[i+13],4,0x289B7EC6);d=HH(d,a,b,c,m[i+0],11,0xEAA127FA);c=HH(c,d,a,b,m[i+3],16,0xD4EF3085);b=HH(b,c,d,a,m[i+6],23,0x4881D05);a=HH(a,b,c,d,m[i+9],4,0xD9D4D039);d=HH(d,a,b,c,m[i+12],11,0xE6DB99E5);c=HH(c,d,a,b,m[i+15],16,0x1FA27CF8);b=HH(b,c,d,a,m[i+2],23,0xC4AC5665);a=II(a,b,c,d,m[i+0],6,0xF4292244);d=II(d,a,b,c,m[i+7],10,0x432AFF97);c=II(c,d,a,b,m[i+14],15,0xAB9423A7);b=II(b,c,d,a,m[i+5],21,0xFC93A039);a=II(a,b,c,d,m[i+12],6,0x655B59C3);d=II(d,a,b,c,m[i+3],10,0x8F0CCC92);c=II(c,d,a,b,m[i+10],15,0xFFEFF47D);b=II(b,c,d,a,m[i+1],21,0x85845DD1);a=II(a,b,c,d,m[i+8],6,0x6FA87E4F);d=II(d,a,b,c,m[i+15],10,0xFE2CE6E0);c=II(c,d,a,b,m[i+6],15,0xA3014314);b=II(b,c,d,a,m[i+13],21,0x4E0811A1);a=II(a,b,c,d,m[i+4],6,0xF7537E82);d=II(d,a,b,c,m[i+11],10,0xBD3AF235);c=II(c,d,a,b,m[i+2],15,0x2AD7D2BB);b=II(b,c,d,a,m[i+9],21,0xEB86D391);a=Add(a,A);b=Add(b,B);c=Add(c,C);d=Add(d,D);}
return(BytesToHex(Int32ToBytes(a),"")+BytesToHex(Int32ToBytes(b),"")+BytesToHex(Int32ToBytes(c),"")+BytesToHex(Int32ToBytes(d),"")).toLowerCase();}
function GetCRC32(t){var s=(arguments.length>1)?arguments[1]:0;var l=(arguments.length>2)?arguments[2]:t.length-s;var Table=(function(){var r=new Int32Array(256);var c;for(var i=0;i<256;i++){c=i;for(var j=0;j<8;j++){if(c&1){c=(c&0xFFFFFFFE)/2&0x7FFFFFFF^0xEDB88320;}
else{c=(c&0xFFFFFFFE)/2&0x7FFFFFFF;}}
r[i]=c;}
return r;})();var c=~0;for(var i=0;i<l;i++){c=(c>>>8)^Table[c&0xFF^t[i+s]];}
return BytesToHex(Int32ToBytes(~c>>>0,false));}
function MillisecondToTime(t){var ms=t;var m=Math.floor(ms/60000);ms-=m*60000;var s=Math.floor(ms/1000);ms-=s*1000;return m.toString()+":"+s.toString().fill("0",2,true)+"."+ms.toString();}
function ComboToScore(n){var r=0;if(n>=100){r+=(n-100)*600;n=100;}
if(n>=50){r+=(n-50)*466;n=50;}
if(n>=20){r+=(n-20)*332;n=20;}
r+=n*200;return r;}</script><script type="text/javascript">String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"");};String.prototype.fill=function(c,l,b){if((c.length=0)||(l<=this.length)){return this;}
if(c.length>1){c=c.substring(0,1);}
var r=[];for(var i=0;i<l-this.length;i++){r.push(c);}
if(b){return r.join("")+this;}
else{return this+r.join("");}};String.prototype.insertEvery=function(s,n){var r=[];for(var i=0;i*2<this.length;i++){r.push(this.substr(i*2,n));}
return r.join(s);}
String.prototype.splitEvery=function(n){var r=[];for(var i=0;i<this.length;i++){r.push(this.substring(i,i+n));i+=n-1;}
return r;}
String.prototype.splice=function(i,n,s){var r=[];r.push(this.substr(0,i));r.push(s);r.push(this.substr(i+n));return r.join("");}
Array.prototype.add=function(a){if(typeof a.length==="undefined"){a=[a];}
for(var i=0;i<a.length;i++){this[this.length]=a[i];}};Array.prototype.replace=function(t,r){for(var i=0;i<this.length;i++){if(this[i]==t){this[i]=r;}}};Array.prototype.write=function(r,s){for(var i=0;i<r.length;i++){if(s+i>this.length-1){break;}
this[s+i]=r[i];}};function DuplicateString(c,n){var r=[];for(var i=0;i<n;i++){r[i]=c;}
return r.join("");}
function LTrimString(t,c){var n=0;for(var i=0;i<t.length;i++){if(t[i]==c){n+=1;}
else{break;}}
return t.substring(n,t.length+1);}
function DuplicateBytes(t,n){var r=new Uint8Array(n);for(var i=0;i<r.length;i++){r[i]=t;}
return r;}
function RTrimBytes(t,c){var n=t.length-1;for(var i=0;i<t.length;i++){if(t[t.length-i-1]==c){n-=1;}
else{break;}}
return SliceBytes(t,0,n+1);}
function FillBytes(t,c,l,b){if(c<0){c=0;}
if(c>255){c=255;}
if(l<0){l=0;}
if(l>t.length){l=t.length;}
var a=new Uint8Array(t.length-l);for(var i=0;i<a.length;i++){a[i]=c;}
var r=new Uint8Array(t.length+a.length);if(b){r.set(a,0);r.set(b,a.length);}
else{r.set(b,0);r.set(a,b.length);}
return r;}
function SliceBytes(t,s,e){return new Uint8Array(new Uint8Array(t).buffer.slice(s,e));}
function BytesToArray(t){var r=[];for(var i=0;i<t.length;i++){r[i]=t[i];}
return r;}
function UnrepeatArray(t){var r=[];var h=[];for(var i=0,e;(e=t[i])!=null;i++){if(!h[e]){r.push(e);h[e]=true;}}
return r;}
function MajorityArray(t){if((typeof(t)=="undefined")||(t.length==0)){return"";}
if(t.length==1){return t[0];}
var u=UnrepeatArray(t);if(u.length==1){return u[0];}
var c=[];for(var i=0;i<u.length;i++){c[i]=0;for(var j=0;j<t.length;j++){if(t[j]==u[i]){c[i]+=1;}}}
var m=c[0];var n=0;for(var i=1;i<c.length;i++){if(c[i]>m){m=c[i];n=i;}}
return u[n];}
function CloseNumber(t,c){var v=(arguments.length>2)?arguments[2]:3;var r=t;if(Math.abs(t-c)<=v){r=c;}
return r;}
function CloseNumbers(t,c,v){var v=(arguments.length>2)?arguments[2]:3;var r=t;for(var i=0;i<c.length;i++){if(Math.abs(t-c[i])<=v){r=c[i];break;}}
return r;}
function SortNumber(a,b){var na=parseFloat(a);var nb=parseFloat(b);if(isNaN(na)||isNaN(nb)){na=a;nb=b;}
return na-nb;}
function SortNumbers(a,b){var r=0;var i=0;while(r==0){if((a.length>i)&&(b.length>i)){var na=parseFloat(a[i]);var nb=parseFloat(b[i]);if((!isNaN(na))&&(!isNaN(nb))){r=SortNumber(na,nb);i+=1;}
else{return a[i]>b[i];}}
else{return r;}}
return r;}
function SortActionParts(a){for(var i=0;i<a.length;i++){switch(a[i][2]){case 0x61:case 0x21:if(a[i][3]<0){var t=a[i];a[i]=a[i-1];a[i-1]=t;}
break;}}
return a;}</script><script type="text/javascript">function BytesToBase64(t){var r=[];var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var c1;var c2;var c3;var i=0;while(i<t.length){c1=t[i++]&0xFF;if(i==t.length){r.push(c.charAt(c1>>2));r.push(c.charAt((c1&0x3)<<4));r.push("==");break;}
c2=t[i++];if(i==t.length){r.push(c.charAt(c1>>2));r.push(c.charAt(((c1&0x3)<<4)|((c2&0xF0)>>4)));r.push(c.charAt((c2&0xF)<<2));r.push("=");break;}
c3=t[i++];r.push(c.charAt(c1>>2));r.push(c.charAt(((c1&0x3)<<4)|((c2&0xF0)>>4)));r.push(c.charAt(((c2&0xF)<<2)|((c3&0xC0)>>6)));r.push(c.charAt(c3&0x3F));}
return r.join("");}
function Base64ToBytes(t){var r=new Uint8Array(t.length/4*3);var c=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);var c1;var c2;var c3;var c4;var i=0;var j=0;while(i<t.length){do{c1=c[t.charCodeAt(i++)&0xFF];}
while(i<t.length&&c1==-1);if(c1==-1)
break;do{c2=c[t.charCodeAt(i++)&0xFF];}
while(i<t.length&&c2==-1);if(c2==-1)
break;r[j++]=((c1<<2)|((c2&0x30)>>4));do{c3=t.charCodeAt(i++)&0xFF;if(c3==61)
return r;c3=c[c3];}
while(i<t.length&&c3==-1);if(c3==-1)
break;r[j++]=(((c2&0xF)<<4)|((c3&0x3C)>>2));do{c4=t.charCodeAt(i++)&0xFF;if(c4==61)
return r;c4=c[c4];}
while(i<t.length&&c4==-1);if(c4==-1)
break;r[j++]=(((c3&0x03)<<6)|c4);}
return r;}
function BytesToText(t){var r="";var t=BytesToHex(t,"");if(t!=""){t="%"+t.insertEvery("%",2);try{r=decodeURIComponent(t);}
catch(e){for(var i=0;i<t.length;i++){try{r+=decodeURIComponent(t.substring(i,i+9));i+=8;}
catch(e){try{r+=decodeURIComponent(t.substring(i,i+6));i+=5;continue;}
catch(e){try{r+=decodeURIComponent(t.substring(i,i+3));i+=2;continue;}
catch(e){r+="?";i+=2;continue;}}}}}}
return r;}
function TextToBytes(t){t=encodeURIComponent(t);var r=[];for(var i=0;i<t.length;i++){if(t.substr(i,1)!="%"){r.push(HexToBytes(t.substr(i,1).charCodeAt().toString(16))[0]);}
else{r.push(HexToBytes(t.substr(i+1,2))[0]);i+=2;}}
return new Uint8Array(r);}
function BytesToHex(t){if(t.length==0){return"";}
var c=(arguments.length>1)?arguments[1]:"";var r=[];for(var i=0;i<t.length;i++){r.push(t[i].toString(16).toUpperCase().fill("0",2,true));}
return r.join(c);}
function HexToBytes(t){if(t==""){return new Uint8Array(0);}
var b=(arguments.length>1)?arguments[1]:false;if(t.length%2!=0){t+="0";}
t=t.toUpperCase();if(b){var d="0123456789ABCDEF";for(var i=0;i<t.length;i++){if(d.indexOf(t[i])==-1){return new Uint8Array(0);}}}
var r=new Uint8Array(t.length/2);for(var i=0;i<r.length;i++){var n;try{n=parseInt(t.substring(i*2,i*2+2),16);}
catch(e){n=0;}
r[i]=n;}
return r;}
function BytesToInt16(t){if(t.length>2){t=SliceBytes(t,0,2);}
var a=new Uint8Array(2);a.set(t);return new DataView(a.buffer).getInt16(0,LittleEndian);}
function Int16ToBytes(t){var e=(arguments.length>1)?arguments[1]:LittleEndian;var d=new DataView(new ArrayBuffer(2));d.setInt16(0,t,e);return new Uint8Array(d.buffer);}
function BytesToInt32(t){if(t.length>4){t=SliceBytes(t,0,4);}
var a=new Uint8Array(4);a.set(t);return new DataView(a.buffer).getInt32(0,LittleEndian);}
function Int32ToBytes(t){var e=(arguments.length>1)?arguments[1]:LittleEndian;var d=new DataView(new ArrayBuffer(4));d.setInt32(0,t,e);return new Uint8Array(d.buffer);}
function BytesToFloat64(t){if(t.length>8){t=SliceBytes(t,0,8);}
var a=new Uint8Array(8);a.set(t);return new DataView(a.buffer).getFloat64(0,LittleEndian);}
function BaseToDec(t){t=t.toUpperCase();var d=(arguments.length>1)?arguments[1]:16;var r=0;var s;var m=1;switch(d){case 16:s="0123456789ABCDEF";break;case 36:s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";break;}
for(var i=0;i<t.length;i++){var p=s.indexOf(t[t.length-i-1]);if(p!=-1){r+=p*m;m*=s.length;}
else{return NaN;}}
return r;}
function DecToBase(t){var d=(arguments.length>1)?arguments[1]:16;var r="";var s;switch(d){case 16:s="0123456789ABCDEF";break;case 36:s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";break;}
while(t>0){var n=t%d;r=s[n]+r;t=Math.floor(t/d);}
return r.fill("0",2,true);}
function TextToHtml(t){return t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;").replace(/"/g,"&quot;");}
function HtmlToText(t){return t.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&nbsp;/g," ").replace(/&quot;/g,'"');}
function Utf8ToUtf16(t){var r=[];var c1;var c2;var c3;var i=0;while(i<t.length){c1=t.charCodeAt(i++);switch(c1>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:r.push(t.charAt(i-1));break;case 12:case 13:c2=t.charCodeAt(i++);r.push(String.fromCharCode(((c1&0x1F)<<6)|(c2&0x3F)));break;case 14:c2=t.charCodeAt(i++);c3=t.charCodeAt(i++);r.push(String.fromCharCode(((c1&0x0F)<<12)|((c2&0x3F)<<6)|((c3&0x3F)<<0)));break;}}
return r.join("");}
function Utf16ToUtf8(t){var r=[];var c;for(var i=0;i<t.length;i++){c=t.charCodeAt(i);if((c>=0x0001)&&(c<=0x007F)){r.push(t.charAt(i));}
else if(c>0x07FF){r.push(String.fromCharCode(0xE0|((c>>12)&0x0F)));r.push(String.fromCharCode(0x80|((c>>6)&0x3F)));r.push(String.fromCharCode(0x80|((c>>0)&0x3F)));}
else{r.push(String.fromCharCode(0xC0|((c>>6)&0x1F)));r.push(String.fromCharCode(0x80|((c>>0)&0x3F)));}}
return r.join("");}</script><script type="text/javascript">function Bin(buffer,type){var _bufferBin;var _bufferXml;var _textXml;var _textHtml;var _isValid=false;var reset=function(){_bufferBin=undefined;_bufferXml=undefined;_textXml=undefined;_textHtml=undefined;_isValid=false;};var fromBinBuffer=function(buffer){reset();_bufferBin=buffer;_isValid=true;};var fromXmlBuffer=function(buffer){_bufferXml=buffer;var b=BytesToText(buffer).replace(/\r\n/g,"");var ReadData=function(f1,f2){var r;var s1=b.indexOf(f1,p);if(s1==-1){p=b.length;return"";}
else{s1+=f1.length;}
var s2=b.indexOf(f2,s1);if(s2==-1){p=b.length;return"";}
p=s2+f2.length;return b.substring(s1,s2);};var WriteByte=function(c){if(c==""){c="0x0 "}
if((c.indexOf("0x")==0)&&(c.lastIndexOf(" ")==(c.length-1))){bin.add(parseInt(c,16));}};var WriteInt16=function(c){if(c==""){c="0 "}
if(c.lastIndexOf(" ")==(c.length-1)){bin.add(BytesToArray(Int16ToBytes(parseInt(c,10))));}};var WriteInt32=function(c){if(c==""){c="0 "}
if(c.lastIndexOf(" ")==(c.length-1)){bin.add(BytesToArray(Int32ToBytes(parseInt(c,10))));}};var WriteDateTime=function(c){if(c==""){c="   0-00-00 00:00:00"}
var a=c.split("-");var y=a[0];WriteInt32(y.toString()+" ");var M=a[1];WriteInt16(M.toString()+" ");a=a[2].split(" ");var d=a[0];WriteInt16(d.toString()+" ");a=a[1].split(":");var H=a[0];WriteInt16(H.toString()+" ");var m=a[1];WriteInt16(m.toString()+" ");var s=a[2];WriteInt16(s.toString()+" ");};var WriteText=function(c,n){var r=BytesToArray(TextToBytes(c));bin.add(r);bin.add(BytesToArray(DuplicateBytes(0,n-r.length)));};var WriteData=function(c,n){switch(n){case 1:WriteByte(c);break;case 2:WriteInt16(c);break;case 4:WriteInt32(c);break;case 14:WriteDateTime(c);break;case 20:case 22:case 32:case 48:case 64:case 128:case 200:case 256:case 300:case 512:case 1024:WriteText(c,n);break;}};var WriteDataE=function(f,t,n){var l=[];for(var i=0;i<n;i++){if(f=="TResHeadAll"){l.push(b);}
else{l.push(ReadData("<"+f+" type="+'"'+t+'"'+">","</"+f+">"));}}
for(var i=0;i<l.length;i++){b=l[i];p=0;switch(f){case"TResHeadAll":WriteData(ReadData("<Version>","</Version>"),4);WriteData(ReadData("<Unit>","</Unit>"),4);WriteData(ReadData("<Count>","</Count>"),4);WriteData(ReadData("<MetalibHash>","</MetalibHash>"),32);WriteData(ReadData("<ResVersion>","</ResVersion>"),2);WriteData(ReadData("<CreateTime>","</CreateTime>"),14);WriteData(ReadData("<ResEncording>","</ResEncording>"),32);WriteData(ReadData("<ContentHash>","</ContentHash>"),32);WriteData("",4);WriteData(ReadData("<DataOffset>","</DataOffset>"),4);break;case"m_astReward":switch(t){case"ActiveReward":if(b!=""){WriteData(ReadData("<m_ucRewardType>","</m_ucRewardType>"),1);WriteData(ReadData("<m_iRewardID>","</m_iRewardID>"),4);WriteData(ReadData("<m_iRewardValue>","</m_iRewardValue>"),4);}
else{WriteData("",1);WriteData("",4);WriteData("",4);}
break;case"MarketActReward":if(b!=""){WriteData(ReadData("<m_ucRewardType>","</m_ucRewardType>"),1);WriteData(ReadData("<m_ushRewardID>","</m_ushRewardID>"),2);WriteData(ReadData("<m_iRewardValue>","</m_iRewardValue>"),4);}
else{WriteData("",1);WriteData("",2);WriteData("",4);}
break;}
break;case"m_astSongs":if(b!=""){WriteData(ReadData("<ID>","</ID>"),2);}
else{WriteData("",2);}
break;}}};var WriteDataT=function(s){if(s.length==0){return;}
b=ReadData("<"+s[0]+">","</"+s[0]+">");p=0;bin=BytesToArray(TextToBytes("MSES"));WriteDataE("TResHeadAll","",1);var l=[];while(p<b.length){l.push(ReadData("<"+s[1]+" version="+'"'+"1"+'"'+">","</"+s[1]+">"))}
for(var i=0;i<l.length;i++){b=l[i];p=0;for(var j=0;j<s[2].length;j++){switch(s[2][j][0]){case 0:WriteData(ReadData("<"+s[2][j][1]+">","</"+s[2][j][1]+">"),s[2][j][2]);break;case 1:var a=s[2][j][1].split(",");WriteDataE(a[0],a[1],s[2][j][2]);break;}}}
bin.write(BytesToArray(Int32ToBytes(l.length)),12);bin.write(TextToBytes(GetMD5(bin.slice(136,bin.length))),96);};var bin=[];var p=0;WriteDataT(GetBinStructure());fromBinBuffer(new Uint8Array(bin));};var toBinBuffer=function(){return _bufferBin;};var toXmlBuffer=function(){if(typeof _textXml==="undefined"){_textXml=toXmlText();}
return TextToBytes(_textXml);};var toXmlText=function(){var b=_bufferBin;var ReadByte=function(){var r=LTrimString(BytesToHex(SliceBytes(b,p,p+1),"").toLowerCase(),"0");if(r==""){r="0";}
p+=1;return"0x"+r+" ";};var ReadInt16=function(){var r=BytesToInt16(SliceBytes(b,p,p+2));p+=2;return r.toString()+" ";};var ReadInt32=function(){var r=BytesToInt32(SliceBytes(b,p,p+4));p+=4;return r.toString()+" ";};var ReadDateTime=function(){var y=BytesToInt32(SliceBytes(b,p,p+4));p+=4;var M=BytesToInt16(SliceBytes(b,p,p+2));p+=2;var d=BytesToInt16(SliceBytes(b,p,p+2));p+=2;var H=BytesToInt16(SliceBytes(b,p,p+2));p+=2;var m=BytesToInt16(SliceBytes(b,p,p+2));p+=2;var s=BytesToInt16(SliceBytes(b,p,p+2));p+=2;return y.toString().fill(" ",4,true).replace(/ /g,"&nbsp;")+"-"+M.toString().fill("0",2,true)+"-"+d.toString().fill("0",2,true)+" "+H.toString().fill("0",2,true)+":"+m.toString().fill("0",2,true)+":"+s.toString().fill("0",2,true);};var ReadText=function(n){var r=BytesToText(RTrimBytes(SliceBytes(b,p,p+n),0));p+=n;return r;};var ReadData=function(n){switch(n){case 1:return ReadByte();break;case 2:return ReadInt16();break;case 4:return ReadInt32();break;case 14:return ReadDateTime();break;case 20:case 22:case 32:case 48:case 64:case 128:case 200:case 256:case 300:case 512:case 1024:return ReadText(n);break;default:p+=n;return"";}};var WriteData=function(l,f,c){xml.push(DuplicateString("&nbsp;",4*l)+"&lt;"+f+"&gt;"+c+"&lt;/"+f+"&gt;");};var WriteDataA=function(l,f,n){WriteData(l,f,ReadData(n));};var WriteDataE=function(l,f,t,n){for(var i=0;i<n;i++){switch(f){case"TResHeadAll":xml.push(DuplicateString("&nbsp;",4*l)+"&lt;"+f+"&nbsp;version=&quot;5&quot;&gt;");xml.push(DuplicateString("&nbsp;",4*(l+1))+"&lt;resHead type=&quot;TResHead&quot;&gt;");xml.push(DuplicateString("&nbsp;",4*(l+2))+"&lt;Magic&gt;1397052237 &lt;/Magic&gt;");WriteDataA(l+2,"Version",4);WriteDataA(l+2,"Unit",4);WriteDataA(l+2,"Count",4);WriteDataA(l+2,"MetalibHash",32);WriteDataA(l+2,"ResVersion",2);WriteDataA(l+2,"CreateTime",14);WriteDataA(l+2,"ResEncording",32);WriteDataA(l+2,"ContentHash",32);p+=4;xml.push(DuplicateString("&nbsp;",4*(l+1))+"&lt;/resHead&gt;");xml.push(DuplicateString("&nbsp;",4*(l+1))+"&lt;resHeadExt&nbsp;type=&quot;TResHeadExt&quot;&gt;");WriteDataA(l+2,"DataOffset",4);xml.push(DuplicateString("&nbsp;",4*(l+1))+"&lt;/resHeadExt&gt;");xml.push(DuplicateString("&nbsp;",4*l)+"&lt;/"+f+"&gt;");break;case"m_astReward":switch(t){case"ActiveReward":var c1=ReadData(1);var c2=ReadData(4);var c3=ReadData(4);if(!((c1=="0x0 ")&&(c2=="0 ")&&(c3=="0 "))){xml.push(DuplicateString("&nbsp;",4*l)+"&lt;"+f+" type=&quot;"+t+"&quot;&gt;");WriteData(l+1,"m_ucRewardType",c1);WriteData(l+1,"m_iRewardID",c2);WriteData(l+1,"m_iRewardValue",c3);xml.push(DuplicateString("&nbsp;",4*l)+"&lt;/"+f+"&gt;");}
break;case"MarketActReward":var c1=ReadData(1);var c2=ReadData(2);var c3=ReadData(4);if(!((c1=="0x0 ")&&(c2=="0 ")&&(c3=="0 "))){xml.push(DuplicateString("&nbsp;",4*l)+"&lt;"+f+" type=&quot;"+t+"&quot;&gt;");WriteData(l+1,"m_ucRewardType",c1);WriteData(l+1,"m_ushRewardID",c2);WriteData(l+1,"m_iRewardValue",c3);xml.push(DuplicateString("&nbsp;",4*l)+"&lt;/"+f+"&gt;");}
break;}
break;case"m_astSongs":var c=ReadData(2);if(!(c=="0 ")){xml.push(DuplicateString("&nbsp;",4*l)+"&lt;"+f+" type=&quot;"+t+"&quot;&gt;");WriteData(l+1,"ID",c);xml.push(DuplicateString("&nbsp;",4*l)+"&lt;/"+f+"&gt;");}
break;}}};var WriteDataT=function(s){if(s.length==0){return;}
p=4;xml.push("&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot; ?&gt;");xml.push("&lt;"+s[0]+"&gt;");WriteDataE(0,"TResHeadAll","",1);while(p<b.length){xml.push("&lt;"+s[1]+" version=&quot;1&quot;&gt;");for(var i=0;i<s[2].length;i++){switch(s[2][i][0]){case 0:WriteDataA(1,s[2][i][1],s[2][i][2]);break;case 1:var a=s[2][i][1].split(",");WriteDataE(1,a[0],a[1],s[2][i][2]);break;}}
xml.push("&lt;/"+s[1]+"&gt;");}
xml.push("&lt;/"+s[0]+"&gt;");};var xml=[];var p=0;WriteDataT(GetBinStructure());return HtmlToText(xml.join("\r\n"));};var toHtmlText=function(){if(typeof _textXml==="undefined"){_textXml=toXmlText();}
var b=_textXml.replace(/\r\n/g,"");var ReadData=function(f1,f2){var r;var s1=b.indexOf(f1,p);if(s1==-1){p=b.length;return"";}
else{s1+=f1.length;}
var s2=b.indexOf(f2,s1);if(s2==-1){p=b.length;return"";}
p=s2+f2.length;return b.substring(s1,s2);};var WriteDataT=function(s){if(s.length==0){return;}
html.push("<html><meta charset ="+'"UTF-8"'+"/><head><title>"+FileName+"</title></head><body><table border="+'"1"'+"><caption>"+FileName+"</caption>");var e=false;for(var i=0;i<s[2].length;i++){if(s[2][i][0]==1){e=true;break;}}
html.push("<tr>");for(var i=0;i<s[2].length;i++){switch(s[2][i][0]){case 0:html.push((e?"<th rowspan="+'"2"'+">":"<th>")+s[2][i][1]+"</th>");break;case 1:var a=s[2][i][1].split(",");switch(a[0]){case"m_astReward":switch(a[1]){case"ActiveReward":html.push(DuplicateString((e?"<th colspan="+'"3"'+">":"<th>")+a[0]+"</th>",s[2][i][2]));break;case"MarketActReward":html.push(DuplicateString((e?"<th colspan="+'"3"'+">":"<th>")+a[0]+"</th>",s[2][i][2]));break;}
break;case"m_astSongs":html.push(DuplicateString((e?"<th colspan="+'"1"'+">":"<th>")+a[0]+"</th>",s[2][i][2]));break;}
break;}}
html.push("</tr>");html.push("<tr>");for(var i=0;i<s[2].length;i++){switch(s[2][i][0]){case 1:var a=s[2][i][1].split(",");switch(a[0]){case"m_astReward":switch(a[1]){case"ActiveReward":html.push(DuplicateString("<th>m_ucRewardType</th><th>m_iRewardID</th><th>m_iRewardValue</th>",s[2][i][2]));break;case"MarketActReward":html.push(DuplicateString("<th>m_ucRewardType</th><th>m_ushRewardID</th><th>m_iRewardValue</th>",s[2][i][2]));break;}
break;case"m_astSongs":html.push(DuplicateString("<th>ID</th>",s[2][i][2]));break;}
break;}}
html.push("</tr>");b=ReadData("<"+s[0]+">","</"+s[0]+">");p=0;var l=[];while(p<b.length){l.push(ReadData("<"+s[1]+" version="+'"'+"1"+'"'+">","</"+s[1]+">"))}
for(var i=0;i<l.length;i++){b=l[i];p=0;html.push("<tr>");for(var j=0;j<s[2].length;j++){switch(s[2][j][0]){case 0:html.push("<td>"+ReadData("<"+s[2][j][1]+">","</"+s[2][j][1]+">")+"</td>");break;case 1:var e=[];for(var k=0;k<s[2][j][2];k++){e.push(ReadData("<"+a[0]+" type="+'"'+a[1]+'"'+">","</"+a[0]+">"));}
for(var k=0;k<s[2][j][2];k++){b=e[k];p=0;var a=s[2][j][1].split(",");switch(a[0]){case"m_astReward":switch(a[1]){case"ActiveReward":html.push("<td>"+ReadData("<m_ucRewardType>","</m_ucRewardType>")+"</td>");html.push("<td>"+ReadData("<m_iRewardID>","</m_iRewardID>")+"</td>");html.push("<td>"+ReadData("<m_iRewardValue>","</m_iRewardValue>")+"</td>");break;case"MarketActReward":html.push("<td>"+ReadData("<m_ucRewardType>","</m_ucRewardType>")+"</td>");html.push("<td>"+ReadData("<m_ushRewardID>","</m_ushRewardID>")+"</td>");html.push("<td>"+ReadData("<m_iRewardValue>","</m_iRewardValue>")+"</td>");break;}
break;case"m_astSongs":html.push("<td>"+ReadData("<ID>","</ID>")+"</td>");break;}}
break;}}
html.push("</tr>");}
html.push("</table></body></html>");};var html=[];var p=0;WriteDataT(GetBinStructure());return html.join("");};this.fromBuffer=function(buffer,type){if(buffer.length==0){return;}
switch(type){case"bin":fromBinBuffer(buffer);break;case"xml":fromXmlBuffer(buffer);break;}};this.toBuffer=function(type){switch(type){case"bin":return toBinBuffer();break;case"xml":if(typeof _bufferXml==="undefined"){_bufferXml=toXmlBuffer();}
return _bufferXml;break;}};this.toText=function(type){switch(type){case"xml":if(typeof _textXml==="undefined"){_textXml=toXmlText();}
return _textXml;break;case"html":if(typeof _textHtml==="undefined"){_textHtml=toHtmlText();}
return _textHtml;break;}};this.IsValid=function(){return _isValid;};this.fromBuffer(buffer,type);}
function Mde(buffer,type){var _bufferMde;var _bufferXml;var _textMde;var _textXml;var _isValid=false;var reset=function(){_bufferMde=undefined;_bufferXml=undefined;_textMde=undefined;_textXml=undefined;_isValid=false;};var fromMdeBuffer=function(buffer){reset();_bufferMde=buffer;_isValid=true;};var fromXmlBuffer=function(buffer){_bufferXml=buffer;var l=buffer.length;var n=0;while(true){n+=65536*4;if(l<=n){l=n;break;}}
var d=new Uint8Array(l);d.set(buffer,0);fromMdeBuffer(TextToBytes(BytesToBase64(d)));};var toMdeBuffer=function(){return _bufferMde;};var toXmlBuffer=function(){if(typeof _textMde==="undefined"){_textMde=BytesToText(_bufferMde);}
return RTrimBytes(Base64ToBytes(_textMde),0);};var toMdeText=function(){return BytesToText(_bufferMde);};var toXmlText=function(){if(typeof _bufferXml==="undefined"){_bufferXml=toXmlBuffer();}
return BytesToText(_bufferXml);};this.fromBuffer=function(buffer,type){if(buffer.length==0){return;}
switch(type){case"mde":fromMdeBuffer(buffer);break;case"xml":fromXmlBuffer(buffer);break;}};this.toBuffer=function(type){switch(type){case"mde":return toMdeBuffer();break;case"xml":if(typeof _bufferXml==="undefined"){_bufferXml=toXmlBuffer();}
return _bufferXml;break;}};this.toText=function(type){switch(type){case"mde":if(typeof _textMde==="undefined"){_textMde=toMdeText();}
return _textMde;break;case"xml":if(typeof _textXml==="undefined"){_textXml=toXmlText();}
return _textXml;break;}};this.IsValid=function(){return _isValid;};this.fromBuffer(buffer,type);}
function Imd(buffer,type){var _bufferImd;var _bufferTxt;var _bufferBms;var _textPng;var _textHtml;var _textImd;var _textTxt;var _textBms;var _isValid=false;var Time=0;var BPM=0;var Beat=0;var Action=0;var Combo=0;var Key=4;var Start=0;var End=0;var Beats=[];var BPMs=[];var Actions=[];var Timestamps=[];var Tracks=[];var Timespans=[];var ActionsL=[];var TimestampsL=[];var TracksL=[];var TimespansL=[];var ActionsS=[];var TimestampsS=[];var TracksS=[];var TimespansS=[];var BeatLines=[];var BeatLines1=[];var BeatLines2=[];var BeatLines4=[];var DeterminePoints=[];var DetermineLines=[];var ComboTimestamps=[];var ComboTracks=[];var reset=function(){_bufferImd=undefined;_bufferTxt=undefined;_bufferBms=undefined;_textPng=undefined;_textHtml=undefined;_textImd=undefined;_textTxt=undefined;_textBms=undefined;_isValid=false;Time=0;BPM=0;Beat=0;Action=0;Combo=0;Key=4;Start=0;End=0;Beats=[];BPMs=[];Actions=[];Timestamps=[];Tracks=[];Timespans=[];ActionsL=[];TimestampsL=[];TracksL=[];TimespansL=[];ActionsS=[];TimestampsS=[];TracksS=[];TimespansS=[];BeatLines=[];BeatLines1=[];BeatLines2=[];BeatLines4=[];DeterminePoints=[];DetermineLines=[];ComboTimestamps=[];ComboTracks=[];};var fromImdBuffer=function(buffer){var checks=(arguments.length>1)?arguments[1]:GetImdCheck();reset();var BeatParts=[];var ActionParts=[];var p=0;Time=BytesToInt32(SliceBytes(buffer,p,p+4));p+=4;Beat=BytesToInt32(SliceBytes(buffer,p,p+4));p+=4;for(var i=0;i<Beat;i++){BeatParts[i]=[];BeatParts[i][0]=BytesToInt32(SliceBytes(buffer,p,p+4));p+=4;BeatParts[i][1]=BytesToFloat64(SliceBytes(buffer,p,p+8));p+=8;}
if(checks[0]){BeatParts=UnrepeatArray(BeatParts).sort(SortNumbers);Beat=BeatParts.length;}
for(var i=0;i<BeatParts.length;i++){Beats.push(BeatParts[i][0]);BPMs.push(BeatParts[i][1]);}
if(checks[0]){for(var i=0;i<Beats.length-1;i++){var b=Math.round(60000/(Beats[i+1]-Beats[i])*1000)/1000;if(BPMs[i]!=CloseNumber(b,BPMs[i])){BPMs[i]=b;}}
BPMs[BPMs.length-1]=BPMs[BPMs.length-2];}
Start=Beats[0];End=Beats[Beats.length-1];BPM=MajorityArray(BPMs);p+=2;Action=BytesToInt32(SliceBytes(buffer,p,p+4));p+=4;for(var i=0;i<Action;i++){ActionParts[i]=[];ActionParts[i][2]=BytesToInt32(SliceBytes(buffer,p,p+2));ActionParts[i][0]=BytesToInt32(SliceBytes(buffer,p+2,p+6));ActionParts[i][1]=BytesToInt32(SliceBytes(buffer,p+6,p+7));ActionParts[i][3]=BytesToInt32(SliceBytes(buffer,p+7,p+11));p+=11;}
for(var i=0;i<ActionParts.length;i++){if(checks[1]&&(ActionParts[i][1]>5)){ActionParts.splice(i,1);i-=1;}}
if(checks[0]){for(var i=0;i<ActionParts.length;i++){if(ActionParts[i][0]==0){ActionParts.splice(i,1);i-=1;continue;}
if(ActionParts[i][2]==0x00){ActionParts[i][3]=0;}}
ActionParts=SortActionParts(UnrepeatArray(ActionParts).sort(SortNumbers));Action=ActionParts.length;}
for(var i=0;i<ActionParts.length;i++){Actions.push(ActionParts[i][2]);Timestamps.push(ActionParts[i][0]);Tracks.push(ActionParts[i][1]);Timespans.push(ActionParts[i][3]);}
var ActionPartsL=[];for(var i=0;i<Actions.length;i++){switch(Actions[i]){case 0x00:ActionPartsL.push([Timestamps[i],Tracks[i],Actions[i],Timespans[i]]);break;case 0x01:case 0xA1:ActionPartsL.push([Timestamps[i],Tracks[i]+Timespans[i],0x00,0]);break;case 0x02:case 0x62:case 0x22:case 0xA2:ActionPartsL.push([Timestamps[i],Tracks[i],0x02,Timespans[i]]);break;case 0x61:case 0x21:break;}}
ActionPartsL=UnrepeatArray(ActionPartsL).sort(SortNumbers);for(var i=0;i<ActionPartsL.length;i++){ActionsL.push(ActionPartsL[i][2]);TimestampsL.push(ActionPartsL[i][0]);TracksL.push(ActionPartsL[i][1]);TimespansL.push(ActionPartsL[i][3]);}
if(checks[2]){Actions=ActionsL;Timestamps=TimestampsL;Tracks=TracksL;Timespans=TimespansL;}
var ActionPartsS=[];for(var i=0;i<Actions.length;i++){switch(Actions[i]){case 0x00:ActionPartsS.push([Timestamps[i],Tracks[i],Actions[i],Timespans[i]]);break;case 0x01:case 0xA1:ActionPartsS.push([Timestamps[i],Tracks[i]+Timespans[i],0x00,0]);break;case 0x02:case 0x62:case 0x22:case 0xA2:ActionPartsS.push([Timestamps[i],Tracks[i],0x00,0]);break;case 0x61:case 0x21:break;}}
ActionPartsS=UnrepeatArray(ActionPartsS).sort(SortNumbers);for(var i=0;i<ActionPartsS.length;i++){ActionsS.push(ActionPartsS[i][2]);TimestampsS.push(ActionPartsS[i][0]);TracksS.push(ActionPartsS[i][1]);TimespansS.push(ActionPartsS[i][3]);}
if(checks[3]){Actions=ActionsS;Timestamps=TimestampsS;Tracks=TracksS;Timespans=TimespansS;}
Action=Actions.length;var imd=new DataView(new ArrayBuffer(14+Beats.length*12+Actions.length*11));p=0;imd.setInt32(p,Time,LittleEndian);p+=4;imd.setInt32(p,Beats.length,LittleEndian);p+=4;for(var i=0;i<Beats.length;i++){imd.setInt32(p,Beats[i],LittleEndian);p+=4;imd.setFloat64(p,BPMs[i],LittleEndian);p+=8;}
imd.setUint8(p,3);p+=1;imd.setUint8(p,3);p+=1;imd.setInt32(p,Actions.length,LittleEndian);p+=4;for(var i=0;i<Actions.length;i++){imd.setInt16(p,Actions[i],LittleEndian);p+=2;imd.setInt32(p,Timestamps[i],LittleEndian);p+=4;imd.setUint8(p,Tracks[i]);p+=1;imd.setInt32(p,Timespans[i],LittleEndian);p+=4;}
_bufferImd=new Uint8Array(imd.buffer);for(var i=0;i<Actions.length;i++){var t=0;switch(Actions[i]){case 0x00:case 0x02:case 0x62:case 0x22:case 0xA2:t=Tracks[i]+1;break;case 0x01:case 0x61:case 0x21:case 0xA1:t=Tracks[i]+Timespans[i]+1;break;}
if(Key<t){Key=t;}}
for(var i=0;i<Beats.length;i++){if(i<Beats.length-1){var n=(Beats[i+1]-Beats[i])/4;BeatLines1.push(Beats[i]);BeatLines.push(Beats[i]);BeatLines4.push(Math.floor(Beats[i]+n));BeatLines.push(Math.floor(Beats[i]+n));BeatLines2.push(Math.floor(Beats[i]+n*2));BeatLines.push(Math.floor(Beats[i]+n*2));BeatLines4.push(Math.floor(Beats[i]+n*3));BeatLines.push(Math.floor(Beats[i]+n*3));}
else{BeatLines1.push(Beats[i]);BeatLines.push(Beats[i]);}}
var ReverseTimestamps=[];var ReverseTracks=[];for(var i=0;i<Key;i++){DeterminePoints[i]=[];}
for(var i=0;i<Actions.length;i++){var t=CloseNumbers(Timestamps[i],BeatLines);switch(Actions[i]){case 0x00:DeterminePoints[Tracks[i]].push(t);break;case 0x01:DeterminePoints[Tracks[i]+Timespans[i]].push(t);break;case 0x21:if(Timespans[i]<0){ReverseTimestamps.push(t);ReverseTracks.push(Tracks[i]);}
break;case 0xA1:DeterminePoints[Tracks[i]+Timespans[i]].push(t);if(Timespans[i]<0){ReverseTimestamps.push(t);ReverseTracks.push(Tracks[i]);}
break;case 0x02:case 0x62:case 0x22:case 0xA2:var dt;var dn;var di;var dr;var dp;dt=Timestamps[i];do{DeterminePoints[Tracks[i]].push(CloseNumbers(Math.round(dt),BeatLines));dn=Math.floor(dt*BPM/60000);if(dn>Beats.length-1){dn=Beats.length-1;}
while(Beats[dn]>dt){dn-=1;}
while(Beats[dn+1]<dt){dn+=1;}
di=(Beats[dn+1]-Beats[dn])/4;dr=Beats[dn+1]-dt;if(dr==0){dn+=1;di=(Beats[dn+1]-Beats[dn])/4;dr=Beats[dn]-dt;}
if(dr>=di){dt+=di;}
else{dt+=dr;dp=1-dr/di;dn+=1;di=(Beats[dn+1]-Beats[dn])/4;dt+=di*dp;}
dt=CloseNumber(dt,Beats[dn]);dt=CloseNumber(dt,Timestamps[i]+Timespans[i]);}
while(dt<=Timestamps[i]+Timespans[i]);break;}}
for(var i=0;i<Key;i++){for(var j=0;j<DeterminePoints[i].length;j++){DetermineLines.push(DeterminePoints[i][j]);}}
DetermineLines=UnrepeatArray(DetermineLines).sort(SortNumber);for(var i=0;i<DetermineLines.length;i++){for(var j=0;j<Key;j++){if(DeterminePoints[j].indexOf(DetermineLines[i])!=-1){ComboTimestamps.push(DetermineLines[i]);ComboTracks.push(j);for(var k=0;k<ReverseTimestamps.length;k++){if((DetermineLines[i]==ReverseTimestamps[k])&&(j==ReverseTracks[k])){var t=ComboTracks[ComboTracks.length-1];ComboTracks[ComboTracks.length-1]=ComboTracks[ComboTracks.length-2];ComboTracks[ComboTracks.length-2]=t;break;}}}}}
Combo=ComboTimestamps.length;_isValid=true;};var fromTxtBuffer=function(buffer){fromImdBuffer(HexToBytes(BytesToText(buffer).replace(/(\r\n|\s+)/g,""),true));};var fromBmsBuffer=function(buffer){var hBPM=130;var hLNTYPE=1;var hLNOBJ="";var hWAVs=[];var hBPMs=[];var a=BytesToText(buffer).replace(/\r/g,"\n").replace(/\n\n/g,"\n").split("\n");var d=[];FileType="bms2";if(FileExtension=="pms"){FileType="pms";}
for(var i=0;i<a.length;i++){if((a[i].length>=5)&&(a[i][0]=="#")){var ps=a[i].indexOf(" ",1);if(ps!=-1){var m=a[i].substring(1,ps).toUpperCase();switch(m){case"BPM":var v=parseFloat(a[i].substring(4));if(!isNaN(v)&&(v!=0)){hBPM=v;}
break;case"LNTYPE":var v=parseInt(a[i].substring(7));if(!isNaN(v)&&(v!=0)){hLNTYPE=v;}
break;case"LNOBJ":var v=a[i].substring(6).trim();if(v.length==2){hLNOBJ=v;}
break;}
if(m.length==5){var n=m.substring(0,3);var c=m.substring(3,5);switch(n){case"BPM":c=BaseToDec(c,36);if(!isNaN(c)){var v=parseFloat(a[i].substring(ps+1));if(!isNaN(v)&&(v!=0)){hBPMs[c]=v;}}
break;case"WAV":c=BaseToDec(c,36);if(!isNaN(c)){var v=a[i].substring(pc+1).trim();if(v!=""){hWAVs[c]=v;}}
break;}}}
else{var pc=a[i].indexOf(":",1);if(pc!=-1){var m=a[i].substring(1,pc).toUpperCase();if(m.length==5){var n=m.substring(0,3);var c=m.substring(3,5);n=parseInt(n);if(!isNaN(n)){if(typeof d[n]==="undefined"){d[n]=[];}
var c=parseInt(a[i].substring(4,pc));if(!isNaN(c)&&(c!=0)){d[n][c]=a[i].substring(pc+1);switch(c){case 16:case 26:case 56:case 66:FileType="bms2";break;case 17:case 27:case 57:case 67:FileType="bm98";break;case 19:case 29:case 59:case 69:if(FileType!="bms2"){FileType="bms";}
break;}}}}}}}}
for(var i=0;i<a.length;i++){if(a[a.length-1-i]!=""){if(i>1){d[d.length-1+i-1]=[];}
break;}}
var StartTime=0;var TimeSigns=[];var InnerBPMs=[];var InnerTimestamps=[];var WAVTimestamps=[];var BPMTimestamps=[];var SnData=[];var LnData=[];var ActionParts=[];var IsAvd=(hLNTYPE==1);var AvdSnScript=["A8","A3","A4","A5","A6","A7","A9","AA","AB","AC","E3","E4","E5","E6","E7","E9","EA","EB","EC"];var AvdLnScript=["A8","B8","C3","C4","C5","C6","C7","C8","C9","CA","CB","CC","D3","D4","D5","D6","D7","D9","DA","DB","DC","E3","E4","E5","E6","E7","E8","E9","EA","EB","EC","F3","F4","F5","F6","F7","F9","FA","FB","FC"];var FillScript=function(t){if(t.length%2!=0){t+="0";}
return t;};var ChanelToTrack=function(c){var r=-1;if(c>40){c-=40;}
switch(FileType){case"bm98":switch(c){case 11:r=0;break;case 12:r=1;break;case 13:r=2;break;case 14:r=3;break;case 15:r=4;break;case 16:r=5;break;case 17:r=6;break;case 21:r=7;break;case 22:r=8;break;case 23:r=9;break;case 24:r=10;break;case 25:r=11;break;case 26:r=12;break;case 27:r=13;break;}
break;case"bms":switch(c){case 11:r=0;break;case 12:r=1;break;case 13:r=2;break;case 14:r=3;break;case 15:r=4;break;case 18:r=5;break;case 19:r=6;break;case 21:r=7;break;case 22:r=8;break;case 23:r=9;break;case 24:r=10;break;case 25:r=11;break;case 28:r=12;break;case 29:r=13;break;}
break;case"bms2":switch(c){case 16:r=0;break;case 11:r=1;break;case 12:r=2;break;case 13:r=3;break;case 14:r=4;break;case 15:r=5;break;case 18:r=6;break;case 26:r=7;break;case 21:r=8;break;case 22:r=9;break;case 23:r=10;break;case 24:r=11;break;case 25:r=12;break;case 28:r=13;break;}
break;case"pms":switch(c){case 11:r=0;break;case 12:r=1;break;case 13:r=2;break;case 14:r=3;break;case 15:r=4;break;case 22:r=5;break;case 23:r=6;break;case 24:r=7;break;case 25:r=8;break;}
break;}
return r;};var MeasureActionTimestamps=function(t,p,l){var r=-1;var n=-1;for(var i=0;i<t.length+1;i++){if(i/t.length>=p/l){n=i;break;}}
if(n==0){r=0;}
else if(n==1){r=t[n-1]-(n/t.length-p/l)*t[n-1];}
else if(n>1){r=t[n-1]-(n/t.length-p/l)*(t[n-1]-t[n-2])*t.length;}
return r;};var MeasureBPMTimestamps=function(t,s){var r=[];var n=Math.ceil(s/0.25);for(var i=0;i<n;i++){r.push(MeasureActionTimestamps(t,i,n));}
return r;};var tm=0;for(var n=0;n<d.length;n++){TimeSigns[n]=1;InnerBPMs[n]=[hBPM];InnerTimestamps[n]=[60000*4/hBPM];if(typeof d[n]!=="undefined"){var InnerBPMs03=[0];var InnerBPMs08=[0];var InnerBPMsM=[];if(typeof d[n][3]!=="undefined"){var s=FillScript(d[n][3]);for(var i=0;i<s.length;i++){var v=BaseToDec(s.substring(i,i+2),16);if(isNaN(v)){v=0;}
InnerBPMs03[i/2]=v;i+=1;}}
if(typeof d[n][8]!=="undefined"){var s=FillScript(d[n][8]);for(var i=0;i<s.length;i++){var v=0;var h=BaseToDec(s.substring(i,i+2),36);if(typeof hBPMs[h]!=="undefined"){v=hBPMs[h];}
InnerBPMs08[i/2]=v;i+=1;}}
for(var i=0;i<InnerBPMs03.length*InnerBPMs08.length;i++){InnerBPMsM[i]=0;if(i%InnerBPMs08.length==0){InnerBPMsM[i]=InnerBPMs03[Math.floor(i/InnerBPMs08.length)];}
if((i%InnerBPMs03.length==0)&&(InnerBPMs08[Math.floor(i/InnerBPMs03.length)]!=0)){InnerBPMsM[i]=InnerBPMs08[Math.floor(i/InnerBPMs03.length)];}}
for(var i=0;i<InnerBPMsM.length;i++){if(InnerBPMsM[i]!=0){hBPM=InnerBPMsM[i];}
InnerBPMsM[i]=hBPM;}
InnerBPMs[n]=InnerBPMsM;if(typeof d[n][2]!=="undefined"){TimeSigns[n]=d[n][2];}
if(InnerTimestamps[n].length==1){InnerTimestamps[n]=(function(){var r=[];var t=0;var u=60000*4*TimeSigns[n]/InnerBPMs[n].length;for(var i=0;i<InnerBPMs[n].length;i++){r[i]=t+u/InnerBPMs[n][i];t=r[i];}
return r;})();}
for(var c=0;c<d[n].length;c++){if(typeof d[n][c]!=="undefined"){var t=ChanelToTrack(c);if(t!=-1){var s=FillScript(d[n][c]);for(var i=0;i<s.length;i++){var u=s.substring(i,i+2);if(u!="00"){if(c<30){if(IsAvd){IsAvd=(AvdSnScript.indexOf(u)!=-1);}
if(typeof SnData[t]==="undefined"){SnData[t]=[];}
SnData[t].push([Math.round(tm+MeasureActionTimestamps(InnerTimestamps[n],i/2,s.length/2)),u]);}
else if((c>50)&&(hLNTYPE==1)){if(IsAvd){IsAvd=(AvdLnScript.indexOf(u)!=-1);}
if(typeof LnData[t]==="undefined"){LnData[t]=[];}
LnData[t].push([Math.round(tm+MeasureActionTimestamps(InnerTimestamps[n],i/2,s.length/2)),u]);}}
i+=1;}}}}
if(typeof d[n][1]!=="undefined"){var s=FillScript(d[n][1]);for(var i=0;i<s.length;i++){var h=BaseToDec(s.substring(i,i+2),36);if(typeof hWAVs[h]!=="undefined"){WAVTimestamps.push(Math.round(tm+MeasureActionTimestamps(InnerTimestamps[n],i/2,s.length/2)));}
i+=1;}}}
var s=MeasureBPMTimestamps(InnerTimestamps[n],TimeSigns[n]);for(var i=0;i<s.length;i++){BPMTimestamps.push(tm+s[i]);}
tm+=InnerTimestamps[n][InnerTimestamps[n].length-1];}
if(WAVTimestamps.length!=0){StartTime=WAVTimestamps[0];}
for(var i=0;i<SnData.length;i++){if(typeof SnData[i]!=="undefined"){for(var j=0;j<SnData[i].length;j++){if((hLNTYPE==2)&&(j!=SnData[i].length-1)&&(SnData[i][j+1][1]==hLNOBJ)){ActionParts.push([SnData[i][j][0],i,2,SnData[i][j+1][0]-SnData[i][j][0]]);j+=1;}
else{if(IsAvd){switch(SnData[i][j][1]){case"A8":ActionParts.push([SnData[i][j][0],i,0x00,0]);break;case"A3":case"A4":case"A5":case"A6":case"A7":case"A9":case"AA":case"AB":case"AC":var t=BaseToDec(SnData[i][j][1],36)-BaseToDec("A8",36);ActionParts.push([SnData[i][j][0],i-t,0x01,t]);break;case"E3":case"E4":case"E5":case"E6":case"E7":case"E9":case"EA":case"EB":case"EC":var t=BaseToDec(SnData[i][j][1],36)-BaseToDec("E8",36);ActionParts.push([SnData[i][j][0],i-t,0xA1,t]);break;}}
else{ActionParts.push([SnData[i][j][0],i,0x00,0]);}}}}}
if(hLNTYPE==1){for(var i=0;i<LnData.length;i++){if(typeof LnData[i]!=="undefined"){for(var j=0;j<LnData[i].length;j++){if(j!=LnData[i].length-1){if(IsAvd){switch(LnData[i][j][1]){case"A8":ActionParts.push([LnData[i][j][0],i,0x02,LnData[i][j+1][0]-LnData[i][j][0]]);break;case"B8":ActionParts.push([LnData[i][j][0],i,0x62,LnData[i][j+1][0]-LnData[i][j][0]]);break;case"C3":case"C4":case"C5":case"C6":case"C7":case"C8":case"C9":case"CA":case"CB":case"CC":var t=BaseToDec(LnData[i][j][1],36)-BaseToDec("C8",36);if(t!=0){ActionParts.push([LnData[i][j][0],i-t,0x61,t]);}
ActionParts.push([LnData[i][j][0],i,0x22,LnData[i][j+1][0]-LnData[i][j][0]]);break;case"D3":case"D4":case"D5":case"D6":case"D7":case"D9":case"DA":case"DB":case"DC":var t=BaseToDec(LnData[i][j][1],36)-BaseToDec("D8",36);if(t!=0){ActionParts.push([LnData[i][j][0],i-t,0x21,t]);}
ActionParts.push([LnData[i][j][0],i,0x22,LnData[i][j+1][0]-LnData[i][j][0]]);break;case"E3":case"E4":case"E5":case"E6":case"E7":case"E8":case"E9":case"EA":case"EB":case"EC":var t=BaseToDec(LnData[i][j][1],36)-BaseToDec("E8",36);if(t!=0){ActionParts.push([LnData[i][j][0],i-t,0x61,t]);}
ActionParts.push([LnData[i][j][0],i,0xA2,LnData[i][j+1][0]-LnData[i][j][0]]);break;case"F3":case"F4":case"F5":case"F6":case"F7":case"F9":case"FA":case"FB":case"FC":var t=BaseToDec(LnData[i][j][1],36)-BaseToDec("F8",36);if(t!=0){ActionParts.push([LnData[i][j][0],i-t,0x21,t]);}
ActionParts.push([LnData[i][j][0],i,0xA2,LnData[i][j+1][0]-LnData[i][j][0]]);break;}}
else{ActionParts.push([LnData[i][j][0],i,0x02,LnData[i][j+1][0]-LnData[i][j][0]]);}
j+=1;}}}}}
for(var i=0;i<ActionParts.length;i++){if(ActionParts[i][0]-StartTime<300){ActionParts.splice(i,1);i-=1;}}
var OriginalKey=0;var ExistKeys=[];for(var i=0;i<ActionParts.length;i++){switch(ActionParts[i][2]){case 0x01:case 0x61:case 0x21:case 0xA1:ExistKeys[ActionParts[i][1]+ActionParts[i][3]]=true;break;default:ExistKeys[ActionParts[i][1]]=true;}}
for(var i=0;i<ExistKeys.length;i++){if((typeof ExistKeys[0]==="undefined")&&(typeof ExistKeys[3]==="undefined")&&(typeof ExistKeys[6]==="undefined")){OriginalKey=4;}
else if((typeof ExistKeys[0]==="undefined")&&(typeof ExistKeys[6]==="undefined")){OriginalKey=5;}
else if(typeof ExistKeys[3]==="undefined"){OriginalKey=6;}}
for(var i=0;i<ActionParts.length;i++){var t;switch(ActionParts[i][2]){case 0x01:case 0x61:case 0x21:case 0xA1:t=ActionParts[i][1]+ActionParts[i][3];break;default:t=ActionParts[i][1];}
switch(OriginalKey){case 4:switch(t){case 1:case 2:ActionParts[i][1]-=1;break;case 4:case 5:ActionParts[i][1]-=2;break;}
break;case 5:ActionParts[i][1]-=1;break;case 6:switch(t){case 4:case 5:case 6:ActionParts[i][1]-=1;break;}
break;}}
ActionParts.sort(SortNumbers);var imd=new DataView(new ArrayBuffer(14+BPMTimestamps.length*12+ActionParts.length*11));var p=0;imd.setInt32(p,Math.round(BPMTimestamps[BPMTimestamps.length-1]+6000/hBPM),LittleEndian);p+=4;imd.setInt32(p,BPMTimestamps.length,LittleEndian);p+=4;BPMTimestamps.push(Math.round(BPMTimestamps[BPMTimestamps.length-1]+60000/hBPM));for(var i=0;i<BPMTimestamps.length-1;i++){imd.setInt32(p,Math.round(BPMTimestamps[i])-StartTime,LittleEndian);p+=4;imd.setFloat64(p,Math.round(60000/(BPMTimestamps[i+1]-BPMTimestamps[i])*1000)/1000,LittleEndian);p+=8;}
imd.setUint8(p,3);p+=1;imd.setUint8(p,3);p+=1;imd.setInt32(p,ActionParts.length,LittleEndian);p+=4;for(var i=0;i<ActionParts.length;i++){imd.setInt16(p,ActionParts[i][2],LittleEndian);p+=2;imd.setInt32(p,ActionParts[i][0]-StartTime,LittleEndian);p+=4;imd.setUint8(p,ActionParts[i][1]);p+=1;imd.setInt32(p,ActionParts[i][3],LittleEndian);p+=4;}
fromImdBuffer(new Uint8Array(imd.buffer));};var toImdBuffer=function(){return _bufferImd;};var toTxtBuffer=function(){if(typeof _textTxt==="undefined"){_textTxt=toTxtText();}
return TextToBytes(_textTxt);};var toBmsBuffer=function(){if(typeof _textBms==="undefined"){_textBms=toBmsText();}
return TextToBytes(_textBms);};var toPngText=function(){var options=(arguments.length>0)?arguments[0]:GetImdOption(false);var ScaleX=parseFloat(options[6]);var ScaleY=parseFloat(options[7]);var PaddingTop=128*ScaleX;var PaddingBottom=64*ScaleX;var PaddingLeft=64*ScaleX;var PaddingRight=64*ScaleX;var CoreWidth=(Key<10?128:256)*ScaleX;var SpeedRate=Math.ceil(Time/(32767-PaddingTop-PaddingBottom));var SplitHeight=PaddingTop+Time/SpeedRate+PaddingBottom;if(ScaleY!=0){SpeedRate=2400/CoreWidth/ScaleX/ScaleY;}
else{ScaleY=2400/CoreWidth/ScaleX/SpeedRate;}
var CoreHeight=(End-Start)/SpeedRate;var WholeWidth=PaddingLeft+CoreWidth+PaddingRight;var WholeHeight=PaddingTop+CoreHeight+PaddingBottom;var SplitCount=Math.ceil(WholeHeight/SplitHeight);var NoteWidth=Math.round(Key<7?CoreWidth/Key*(105-5*Key)/100:CoreWidth/Key*0.85);var NoteHeight=Math.round(Key<7?CoreWidth/16:NoteWidth/2);;var TouchNoteStyle="#0000FF";var HoldNoteStyle="#00FF00";var StrokeWidth=CoreWidth/32;var StrokeStyle="#00FF00";var ArrowStyle="#00FF00";var BackgroundStyle="#FFFFFF";var FrameStokeWidth=1*ScaleX;var FrameStokeStyle="#000000";var TrackLineWidth=0.24*ScaleX;var TrackLineStyle="#00FFFF";var BeatLineWidth=0.24*ScaleX;var BeatLineStyle="#000000";var StartLineWidth=0.96*ScaleX;var StartLineStyle="#0000FF";var DetermineLineWidth=0.24*ScaleX;var DetermineLineStyle="#FF0000";var DeterminePointRadius=NoteHeight/2;var DeterminePointStyle="#FF00FF";var TextStyle="#000000";var TextFont="12px Arial";var BoldTextFont="14px 微软雅黑 bold";var cvs=[];var ctx=[];for(var i=0;i<SplitCount;i++){cvs[i]=document.createElement("canvas");cvs[i].style.display="none";cvs[i].width=WholeWidth;cvs[i].height=((i!=SplitCount-1)?SplitHeight:((WholeHeight==SplitHeight)?WholeHeight:(WholeHeight%SplitHeight)));ctx[i]=cvs[i].getContext("2d");}
var DrawLine=function(x1,y1,x2,y2,w,s,t){var i1;var i2;if(y1>y2){i1=Math.floor(y2/SplitHeight);i2=Math.floor(y1/SplitHeight);}
else if(y1<y2){i1=Math.floor(y1/SplitHeight);i2=Math.floor(y2/SplitHeight);}
else{i1=Math.floor((y1-w/2)/SplitHeight);i2=Math.floor((y2+w/2)/SplitHeight);}
if(i1<0){i1=0;}
if(i2>SplitCount-1){i2=SplitCount-1;}
for(var i=i1;i<i2+1;i++){switch(t){case 1:ctx[i].beginPath();ctx[i].moveTo(Math.round(x1),Math.round(y1-SplitHeight*i));ctx[i].lineTo(Math.round(x2),Math.round(y2-SplitHeight*i));ctx[i].lineWidth=w;ctx[i].strokeStyle=s;ctx[i].stroke();break;case 2:ctx[i].beginPath();var n=Math.ceil(Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))/20);var x=Math.min(x1,x2);var xs=Math.abs(x1-x2)/(n*2+1);var y=Math.min(y1,y2);var ys=Math.abs(y1-y2)/(n*2+1);for(var j=0;j<n+1;j++){ctx[i].moveTo(Math.round(x),Math.round(y-SplitHeight*i));x+=xs;y+=ys;ctx[i].lineTo(Math.round(x),Math.round(y-SplitHeight*i));x+=xs;y+=ys;}
ctx[i].lineWidth=w;ctx[i].strokeStyle=s;ctx[i].stroke();break;case 4:ctx[i].beginPath();var n=Math.ceil(Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))/10);var x=Math.min(x1,x2);var xs=Math.abs(x1-x2)/(n*2+1);var y=Math.min(y1,y2);var ys=Math.abs(y1-y2)/(n*2+1);for(var j=0;j<n+1;j++){ctx[i].moveTo(Math.round(x),Math.round(y-SplitHeight*i));x+=xs;y+=ys;ctx[i].lineTo(Math.round(x),Math.round(y-SplitHeight*i));x+=xs;y+=ys;}
ctx[i].lineWidth=w;ctx[i].strokeStyle=s;ctx[i].stroke();break;}}};var DrawPoint=function(x,y,r,s){var i1=Math.floor((y-r)/SplitHeight);var i2=Math.floor((y+r)/SplitHeight);if(i1<0){i1=0;}
if(i2>SplitCount-1){i2=SplitCount-1;}
for(var i=i1;i<i2+1;i++){ctx[i].beginPath();ctx[i].arc(Math.round(x),Math.round(y-SplitHeight*i),r,0,Math.PI*2);s=ctx[i].createRadialGradient(Math.round(x),Math.round(y-SplitHeight*i),r/8,Math.round(x),Math.round(y-SplitHeight*i),r);s.addColorStop(0,"#FFCCCC");s.addColorStop(0.5,"#FF6666");s.addColorStop(1,"#FF0000");ctx[i].fillStyle=s;ctx[i].fill();}};var DrawText=function(x,y,t,s,f,a){var n=GetFontSize(f)*ScaleX;var i1=Math.floor((y-n)/SplitHeight);var i2=Math.floor((y+n)/SplitHeight);if(i1<0){i1=0;}
if(i2>SplitCount-1){i2=SplitCount-1;}
for(var i=i1;i<i2+1;i++){ctx[i].fillStyle=s;ctx[i].font=SetFontSize(f,n);ctx[i].textAlign=a;ctx[i].fillText(t,Math.round(x),Math.round(y-SplitHeight*i));}};var DrawNote=function(a,x,y){var i1=Math.floor((y-NoteHeight/2)/SplitHeight);var i2=Math.floor((y+NoteHeight/2)/SplitHeight);if(i1<0){i1=0;}
if(i2>SplitCount-1){i2=SplitCount-1;}
for(var i=i1;i<i2+1;i++){switch(a){case 0:ctx[i].fillStyle=TouchNoteStyle;break;default:ctx[i].fillStyle=HoldNoteStyle;break;}
ctx[i].fillRect(Math.round(x-NoteWidth/2),Math.round(y-SplitHeight*i-NoteHeight/2),NoteWidth,NoteHeight);}};var DrawStroke=function(x1,y1,x2,y2){DrawLine(Math.round(x1),Math.round(y1),Math.round(x2),Math.round(y2),StrokeWidth,StrokeStyle,1);};var DrawArrow=function(t,x,y){var i1=Math.floor((y-StrokeWidth)/SplitHeight);var i2=Math.floor((y+StrokeWidth)/SplitHeight);if(i1<0){i1=0;}
if(i2>SplitCount-1){i2=SplitCount-1;}
for(var i=i1;i<i2+1;i++){ctx[i].beginPath();if(t<0){ctx[i].moveTo(Math.round(x+StrokeWidth/2),Math.round(y-SplitHeight*i+StrokeWidth));ctx[i].lineTo(Math.round(x+StrokeWidth/2),Math.round(y-SplitHeight*i-StrokeWidth));ctx[i].lineTo(Math.round(x+StrokeWidth/2-StrokeWidth*2),Math.round(y-SplitHeight*i));}
else if(t>0){ctx[i].moveTo(Math.round(x-StrokeWidth/2),Math.round(y-SplitHeight*i+StrokeWidth));ctx[i].lineTo(Math.round(x-StrokeWidth/2),Math.round(y-SplitHeight*i-StrokeWidth));ctx[i].lineTo(Math.round(x-StrokeWidth/2+StrokeWidth*2),Math.round(y-SplitHeight*i));}
ctx[i].closePath();ctx[i].lineWidth=1;ctx[i].fillStyle=ArrowStyle;ctx[i].fill();}};var DrawKey=function(Action,Timestamp,Track,Timespan){switch(Action){case 0x00:DrawNote(Action,CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);break;case 0x01:DrawNote(Action,CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);if(Timespan<0){DrawStroke(CoreWidth/Key*(Track+0.5+Timespan)+StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)-NoteWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);DrawArrow(Timespan,CoreWidth/Key*(Track+0.5+Timespan)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);}
else if(Timespan>0){DrawStroke(CoreWidth/Key*(Track+0.5)+NoteWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5+Timespan)-StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);DrawArrow(Timespan,CoreWidth/Key*(Track+0.5+Timespan)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);}
break;case 0x02:DrawNote(Action,CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);DrawStroke(CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-NoteHeight/2-PaddingBottom,CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-Timespan/SpeedRate+StrokeWidth/2-PaddingBottom);DrawStroke(CoreWidth/Key*(Track+0.5)-StrokeWidth+PaddingLeft,WholeHeight-Timestamp/SpeedRate-Timespan/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)+StrokeWidth+PaddingLeft,WholeHeight-Timestamp/SpeedRate-Timespan/SpeedRate-PaddingBottom);break;case 0x61:DrawNote(Action,CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);if(Timespan<0){DrawStroke(CoreWidth/Key*(Track+0.5+Timespan)-StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)-NoteWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);}
else if(Timespan>0){DrawStroke(CoreWidth/Key*(Track+0.5)+NoteWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5+Timespan)+StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);}
break;case 0x62:DrawNote(Action,CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);DrawStroke(CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-NoteHeight/2-PaddingBottom,CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-Timespan/SpeedRate+StrokeWidth/2-PaddingBottom);break;case 0x21:if(Timespan<0){DrawStroke(CoreWidth/Key*(Track+0.5+Timespan)-StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)+StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);}
else if(Timespan>0){DrawStroke(CoreWidth/Key*(Track+0.5)-StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5+Timespan)+StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);}
break;case 0x22:DrawStroke(CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-StrokeWidth/2-PaddingBottom,CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-Timespan/SpeedRate+StrokeWidth/2-PaddingBottom);break;case 0xA1:if(Timespan<0){DrawStroke(CoreWidth/Key*(Track+0.5+Timespan)+StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)+StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);DrawArrow(Timespan,CoreWidth/Key*(Track+0.5+Timespan)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);}
else if(Timespan>0){DrawStroke(CoreWidth/Key*(Track+0.5)-StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5+Timespan)-StrokeWidth/2+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);DrawArrow(Timespan,CoreWidth/Key*(Track+0.5+Timespan)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-PaddingBottom);}
break;case 0xA2:DrawStroke(CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-StrokeWidth/2-PaddingBottom,CoreWidth/Key*(Track+0.5)+PaddingLeft,WholeHeight-Timestamp/SpeedRate-Timespan/SpeedRate+StrokeWidth/2-PaddingBottom);DrawStroke(CoreWidth/Key*(Track+0.5)-StrokeWidth+PaddingLeft,WholeHeight-Timestamp/SpeedRate-Timespan/SpeedRate-PaddingBottom,CoreWidth/Key*(Track+0.5)+StrokeWidth+PaddingLeft,WholeHeight-Timestamp/SpeedRate-Timespan/SpeedRate-PaddingBottom);break;}};if(options[0]){for(var i=0;i<SplitCount;i++){ctx[i].fillStyle=BackgroundStyle;ctx[i].fillRect(0,0,cvs[i].width,cvs[i].height);}}
for(var i=0;i<SplitCount;i++){ctx[i].globalAlpha=0.618;}
if(options[1]){for(var i=0;i<Key+1;i++){DrawLine(CoreWidth/Key*i+PaddingLeft,WholeHeight-PaddingBottom,CoreWidth/Key*i+PaddingLeft,PaddingTop,TrackLineWidth,TrackLineStyle,1);DrawLine(CoreWidth/Key*i+PaddingLeft,WholeHeight-PaddingBottom,CoreWidth/Key*i+PaddingLeft,PaddingTop,TrackLineWidth,TrackLineStyle,1);}}
if(options[2]){DrawLine(0,1,0,WholeHeight-1,FrameStokeWidth,FrameStokeStyle,1);DrawLine(WholeWidth,1,WholeWidth,WholeHeight-2,FrameStokeWidth,FrameStokeStyle,1);DrawLine(0,0,WholeWidth,0,FrameStokeWidth,FrameStokeStyle,1);DrawLine(0,WholeHeight-1,WholeWidth,WholeHeight-1,FrameStokeWidth,FrameStokeStyle,1);}
if(options[3]){for(var i=0;i<BeatLines1.length;i++){if((BeatLines1[i]!=Start)&&(BeatLines1[i]!=End)){DrawLine(0,WholeHeight-(BeatLines1[i]-Start)/SpeedRate-BeatLineWidth/2-PaddingBottom,WholeWidth,WholeHeight-(BeatLines1[i]-Start)/SpeedRate-BeatLineWidth/2-PaddingBottom,BeatLineWidth,BeatLineStyle,1);DrawText(0,WholeHeight-1-(BeatLines1[i]-Start)/SpeedRate-BeatLineWidth/2-PaddingBottom,Math.round(BeatLines1[i]).toString(),BeatLineStyle,TextFont,"left");}}
for(var i=0;i<BeatLines2.length;i++){DrawLine(0,WholeHeight-(BeatLines2[i]-Start)/SpeedRate-BeatLineWidth/2-PaddingBottom,WholeWidth,WholeHeight-(BeatLines2[i]-Start)/SpeedRate-BeatLineWidth/2-PaddingBottom,BeatLineWidth,BeatLineStyle,2);DrawText(0,WholeHeight-1-(BeatLines2[i]-Start)/SpeedRate-BeatLineWidth/2-PaddingBottom,Math.round(BeatLines2[i]).toString(),BeatLineStyle,TextFont,"left");}
for(var i=0;i<BeatLines4.length;i++){DrawLine(0,WholeHeight-(BeatLines4[i]-Start)/SpeedRate-BeatLineWidth/2-PaddingBottom,WholeWidth,WholeHeight-(BeatLines4[i]-Start)/SpeedRate-BeatLineWidth/2-PaddingBottom,BeatLineWidth,BeatLineStyle,4);DrawText(0,WholeHeight-1-(BeatLines4[i]-Start)/SpeedRate-BeatLineWidth/2-PaddingBottom,Math.round(BeatLines4[i]).toString(),BeatLineStyle,TextFont,"left");}
DrawLine(0,WholeHeight-(Start-Start)/SpeedRate-StartLineWidth/2-PaddingBottom,WholeWidth,WholeHeight-(Start-Start)/SpeedRate-StartLineWidth/2-PaddingBottom,BeatLineWidth,StartLineStyle,1);DrawText(0,WholeHeight-1-(Start-Start)/SpeedRate-StartLineWidth/2-PaddingBottom,Start.toString(),StartLineStyle,TextFont,"left");DrawLine(0,WholeHeight-(End-Start)/SpeedRate-StartLineWidth/2-PaddingBottom,WholeWidth,WholeHeight-(End-Start)/SpeedRate-StartLineWidth/2-PaddingBottom,BeatLineWidth,StartLineStyle,1);DrawText(0,WholeHeight-1-(End-Start)/SpeedRate-StartLineWidth/2-PaddingBottom,End.toString(),StartLineStyle,TextFont,"left");}
for(var i=0;i<Actions.length;i++){DrawKey(Actions[i],Timestamps[i]-Start,Tracks[i],Timespans[i])}
if(options[5]){for(var i=0;i<DetermineLines.length;i++){DrawLine(0,WholeHeight-(DetermineLines[i]-Start)/SpeedRate-DetermineLineWidth/2-PaddingBottom,WholeWidth,WholeHeight-(DetermineLines[i]-Start)/SpeedRate-DetermineLineWidth/2-PaddingBottom,DetermineLineWidth,DetermineLineStyle,1);DrawText(WholeWidth,WholeHeight-1-(DetermineLines[i]-Start)/SpeedRate-DetermineLineWidth/2-PaddingBottom,Math.round(DetermineLines[i]).toString(),DetermineLineStyle,TextFont,"right");}}
if(options[4]){for(var i=0;i<ComboTimestamps.length;i++){DrawPoint(CoreWidth/Key*(ComboTracks[i]+0.5)+PaddingLeft,WholeHeight-(ComboTimestamps[i]-Start)/SpeedRate-PaddingBottom,DeterminePointRadius,DeterminePointStyle);DrawText(CoreWidth/Key*(ComboTracks[i]+0.5)+PaddingLeft,WholeHeight-(ComboTimestamps[i]-Start)/SpeedRate-PaddingBottom-NoteHeight/2,(i+1).toString(),DeterminePointStyle,TextFont,"center");}}
DrawText(WholeWidth/2,18*ScaleX,FileName+"."+FileExtension,TextStyle,BoldTextFont,"center");DrawText(0+PaddingLeft/1.3,38*ScaleX,"时间："+MillisecondToTime(Time).toString(),TextStyle,TextFont,"left");DrawText(WholeWidth-CoreWidth/2-PaddingRight/1.3,38*ScaleX,"拍速："+BPM.toString(),TextStyle,TextFont,"left");DrawText(0+PaddingLeft/1.3,56*ScaleX,"节拍："+Beat.toString(),TextStyle,TextFont,"left");DrawText(WholeWidth-CoreWidth/2-PaddingRight/1.3,56*ScaleX,"动作："+Action.toString(),TextStyle,TextFont,"left");DrawText(0+PaddingLeft/1.3,74*ScaleX,"音符："+Combo.toString(),TextStyle,TextFont,"left");DrawText(WholeWidth-CoreWidth/2-PaddingRight/1.3,74*ScaleX,"键位："+Key.toString(),TextStyle,TextFont,"left");DrawText(0+PaddingLeft/1.3,92*ScaleX,"满分："+ComboToScore(Combo).toString(),TextStyle,TextFont,"left");DrawText(WholeWidth-CoreWidth/2-PaddingRight/1.3,92*ScaleX,"速率："+ScaleY.toString(),TextStyle,TextFont,"left");DrawText(WholeWidth/2,WholeHeight-48*ScaleX,"Draw by rmstZ.html",TextStyle,TextFont,"center");DrawText(WholeWidth/2,WholeHeight-30*ScaleX,"in "+GetDateTime(),TextStyle,TextFont,"center");DrawText(WholeWidth/2,WholeHeight-10*ScaleX,"Copyright © 心のsky Group",TextStyle,BoldTextFont,"center");var png=[];for(var i=0;i<SplitCount;i++){png[i]=cvs[i].toDataURL("image/png");}
return png.join("|");};var toHtmlText=function(){var png=toPngText(GetImdOption(true)).split("|");var html=[];html.push("<html><head><title>"+FileName+"."+FileExtension+"</title><style type="+'"'+"text/css"+'"'+">div{text-align:center;}</style></head><body>");for(var i=0;i<png.length;i++){html.push("<div><img src="+'"'+png[i]+'"'+"/></div>");}
html.push("</body></html>");return html.join("");};var toImdText=function(){if(typeof _textTxt==="undefined"){_textTxt=toTxtText();}
return _textTxt;};var toTxtText=function(){var Beat=0;var Action=0;var txt=[];var p=0;txt.push(BytesToHex(SliceBytes(_bufferImd,p,p+4)," "));p+=4;Beat=BytesToInt32(SliceBytes(_bufferImd,p,p+4));txt.push(BytesToHex(SliceBytes(_bufferImd,p,p+4)," "));p+=4;for(var i=0;i<Beat;i++){txt.push(BytesToHex(SliceBytes(_bufferImd,p,p+12)," "));p+=12;}
txt.push(BytesToHex(SliceBytes(_bufferImd,p,p+2)," "));p+=2;Action=BytesToInt32(SliceBytes(_bufferImd,p,p+4));txt.push(BytesToHex(SliceBytes(_bufferImd,p,p+4)," "));p+=4;for(var i=0;i<Action;i++){txt.push(BytesToHex(SliceBytes(_bufferImd,p,p+11)," "));p+=11;}
return txt.join("\r\n");};var toBmsText=function(){var BeatsB=[];var ActionPartsB=[];var ActionsB=[];var TimestampsB=[];var TracksB=[];var TimespansB=[];var ActionsS=[];var TimespansS=[];var b=0;for(var i=0;i<BPMs.length-1;i++){BeatsB.push(Math.round(b));b+=60000/BPMs[i];}
while(b<Time){BeatsB.push(Math.round(b));b+=60000/BPMs[BPMs.length-1];}
var SlideParts=[];for(var i=0;i<Actions.length;i++){switch(Actions[i]){case 0x00:ActionPartsB.push([-Start+Timestamps[i],Tracks[i],Actions[i],Timespans[i],Actions[i],Timespans[i]]);break;case 0x01:case 0xA1:ActionPartsB.push([-Start+Timestamps[i],Tracks[i]+Timespans[i],0x00,0,Actions[i],Timespans[i]]);break;case 0x61:case 0x21:SlideParts.push([-Start+Timestamps[i],Tracks[i],Actions[i],Timespans[i]]);break;}}
for(var i=0;i<Actions.length;i++){switch(Actions[i]){case 0x02:case 0x62:ActionPartsB.push([-Start+Timestamps[i],Tracks[i],0x02,0,Actions[i],0]);ActionPartsB.push([-Start+Timestamps[i]+Timespans[i],Tracks[i],0x02,0,Actions[i],0]);break;case 0x22:case 0xA2:var t=0;for(var j=0;j<SlideParts.length;j++){if((SlideParts[j][0]==-Start+Timestamps[i])&&(SlideParts[j][1]+SlideParts[j][3]==Tracks[i])){t=SlideParts[j][3];if(SlideParts[j][2]==0x21){t+=36;}
break;}}
ActionPartsB.push([-Start+Timestamps[i],Tracks[i],0x02,0,Actions[i],t]);ActionPartsB.push([-Start+Timestamps[i]+Timespans[i],Tracks[i],0x02,0,Actions[i],t]);break;}}
ActionPartsB=SortActionParts(UnrepeatArray(ActionPartsB).sort(SortNumbers));for(var i=0;i<ActionPartsB.length;i++){ActionsB.push(ActionPartsB[i][2]);TimestampsB.push(ActionPartsB[i][0]);TracksB.push(ActionPartsB[i][1]);TimespansB.push(ActionPartsB[i][3]);ActionsS.push(ActionPartsB[i][4]);TimespansS.push(ActionPartsB[i][5]);}
for(var i=0;i<TimestampsB.length;i++){var n=Math.floor(TimestampsB[i]*BPM/60000);if(n>BeatsB.length-1){n=BeatsB.length-1;}
while(BeatsB[n]>TimestampsB[i]){n-=1;}
while(BeatsB[n+1]<TimestampsB[i]){n+=1;}
var t=BeatsB[n+1]-BeatsB[n];for(var j=0;j<17;j++){var c=CloseNumber(TimestampsB[i],BeatsB[n]+t/16*j);if(TimestampsB[i]!=c){TimestampsB[i]=c;continue;}}}
var TrackToChanel=function(t,b){switch(Key){case 4:switch(t){case 0:case 1:t+=1;break;case 2:case 3:t+=2;break;}
break;case 5:t+=1;break;case 6:switch(t){case 3:case 4:case 5:t+=1;break;}
break;}
var r;switch(t){case 0:r=16;break;case 1:r=11;break;case 2:r=12;break;case 3:r=13;break;case 4:r=14;break;case 5:r=15;break;case 6:r=18;break;case 7:r=26;break;case 8:r=21;break;case 9:r=22;break;case 10:r=23;break;case 11:r=24;break;case 12:r=25;break;case 13:r=28;break;}
if(b){r+=40;}
return r;};var AddScript=function(t,t1,t2,b1,b2){var c=(arguments.length>5)?arguments[5]:"01";if(typeof t==="undefined"){t=DuplicateString("0",b1*32);}
t2-=t1/32;for(var i=0;i<16;i++){if(t1/16*i>=t2){t=t.splice(b2*32+i*2,2,c);break;}}
return t;};var ReductScript=function(t){var b=(arguments.length>1)?arguments[1]:true;var r=t;if(b){while(r.length>2){var a1=r.splitEvery(2);var a2=[];for(var i=0;i<a1.length;i++){i+=1;if(i<a1.length){if(a1[i]!="00"){return r;}
else{a2.push(a1[i-1]);}}}
r=a2.join("");}}
return r;};var BOM=Math.ceil(BeatsB.length/4/1000)*4;var hBPM=BPM;var hBPMs=[];var hdBPMs=[];var md=[];var j=0;var w=false;for(var i=0;i<BeatsB.length;i++){var m=Math.floor(i/BOM);var b=(m+1)*BOM<=BeatsB.length?BOM:BeatsB.length-m*BOM;var n=i%b;if(typeof md[m]==="undefined"){md[m]=[];if(b!=4){md[m][2]=(b/4).toString();}}
if(!w&&(-Start>=BeatsB[i])&&(-Start<BeatsB[i+1])){md[m][1]=AddScript(md[m][1],BeatsB[i+1]-BeatsB[i],-Start-BeatsB[i],b,n,"FF");w=true;}
if(BPMs[i]!=hBPM){if(BPMs[i]==Math.round(BPMs[i])){md[m][3]=AddScript(md[m][3],BeatsB[i+1]-BeatsB[i],0,b,n,DecToBase(BPMs[i]));}
else{var l=hBPMs.indexOf(BPMs[i]);if(l==-1){hBPMs.push(BPMs[i]);l=hBPMs.length-1;}
md[m][8]=AddScript(md[m][8],BeatsB[i+1]-BeatsB[i],0,b,n,DecToBase(l+1,36));}
hBPM=BPMs[i];}
while(TimestampsB[j]<BeatsB[i+1]){var c=TrackToChanel(TracksB[j],ActionsB[j]==0x02);var t="00";switch(ActionsS[j]){case 0x00:case 0x01:case 0x02:t="A8";break;case 0x62:t="B8";break;case 0x22:t="C8";break;case 0xA1:case 0xA2:t="E8";break;}
if(ActionsS[j]!=0x00){t=DecToBase(BaseToDec(t,36)+TimespansS[j],36);}
md[m][c]=AddScript(md[m][c],BeatsB[i+1]-BeatsB[i],TimestampsB[j]-BeatsB[i],b,n,t);j+=1;}}
for(var i=0;i<md.length;i++){if(typeof md[i]==="undefined"){md[i]="";}
else{var sd=[];for(var j=0;j<md[i].length;j++){if(typeof md[i][j]!=="undefined"){sd.push("#"+i.toString().fill("0",3,true)+j.toString().fill("0",2,true)+":"+ReductScript(md[i][j],j!=2));}}
md[i]=sd.join("\r\n");if(md[i]!=""){md[i]+="\r\n";}}}
for(var i=0;i<hBPMs.length;i++){hdBPMs.push("#BPM"+DecToBase(i+1,36).fill("0",2,true)+" "+hBPMs[i].toString());}
var hTitle=FileName.replace(/(_4k|_5k|_6k|_ez|_nm|_hd)/g,"");var bms=[];bms.push("");bms.push("*---------------------- HEADER FIELD");bms.push("");bms.push("#PLAYER ");bms.push("#GENRE ");bms.push("#TITLE "+hTitle);bms.push("#ARTIST rmstZ_"+FileExtension);bms.push("#BPM "+BPM.toString());bms.push("#PLAYLEVEL ");bms.push("#RANK ");bms.push("#TOTAL ");bms.push("#STAGEFILE ");bms.push("#DIFFICULTY ");bms.push("#SUBTITLE ");bms.push("");bms.push("#WAVFF "+hTitle+".mp3");bms.push("");bms.push(hdBPMs.join("\r\n"));bms.push("");bms.push("");bms.push("");bms.push("#LNTYPE 1");bms.push("");bms.push("");bms.push("");bms.push("*---------------------- MAIN DATA FIELD");bms.push("");bms.push("");bms.push(md.join("\r\n"));return bms.join("\r\n");};this.fromBuffer=function(buffer,type){if(buffer.length==0){return;}
switch(type){case"imd":fromImdBuffer(buffer);break;case"txt":fromTxtBuffer(buffer);break;case"bms":fromBmsBuffer(buffer);break;}};this.toBuffer=function(type){switch(type){case"imd":return toImdBuffer();break;case"txt":if(typeof _bufferTxt==="undefined"){_bufferTxt=toTxtBuffer();}
return _bufferTxt;break;case"bms":if(typeof _bufferBms==="undefined"){_bufferBms=toBmsBuffer();}
return _bufferBms;break;}};this.toText=function(type){switch(type){case"png":if(typeof _textPng==="undefined"){_textPng=toPngText();}
return _textPng;break;case"html":if(typeof _textHtml==="undefined"){_textHtml=toHtmlText();}
return _textHtml;case"imd":if(typeof _textImd==="undefined"){_textImd=toImdText();}
return _textImd;break;case"txt":if(typeof _textTxt==="undefined"){_textTxt=toTxtText();}
return _textTxt;break;case"bms":if(typeof _textBms==="undefined"){_textBms=toBmsText();}
return _textBms;break;}};this.IsValid=function(){return _isValid;};this.ReDraw=function(){_textPng=toPngText();_textHtml=toHtmlText();};this.fromBuffer(buffer,type);}
function Img(buffer,type){var _bufferImg;var _textPng=[];var _isValid=false;var reset=function(){_bufferImg=undefined;_textPng=[];_isValid=false;};var fromImgBuffer=function(buffer){reset();_bufferImg=buffer;_isValid=true;};this.fromBuffer=function(buffer,type){if(buffer.length==0){return;}
switch(type){case"img":fromImgBuffer(buffer);break;}};var toPngText=function(){var a=GetImgSelect().split("×");var w=a[0];var h=a[1];var img=document.createElement("img");img.style.display="none";img.src=GetImgSrc(_bufferImg);var cvs=document.createElement("canvas");cvs.style.display="none";cvs.width=w;cvs.height=h;var ctx=cvs.getContext("2d");if(img.width/img.height>=w/h){var r=h/img.height;ctx.drawImage(img,(img.width-w/r)/2,0,w/r,h/r,0,0,w,h);}
else{var r=w/img.width;ctx.drawImage(img,0,(img.height-h/r)/2,w/r,h/r,0,0,w,h);}
return cvs.toDataURL("image/png");;};this.toText=function(type,i){switch(type){case"png":if(typeof _textPng[i]==="undefined"){_textPng[i]=toPngText();}
return _textPng[i];break;}};this.IsValid=function(){return _isValid;};this.fromBuffer(buffer,type);}
function Mp3ToImd(b){var _bufferMp3;var _bufferImd;var _textImd;var _isValid=false;var reset=function(){_bufferMp3=undefined;_bufferImd=undefined;_textImd=undefined;_isValid=false;};var fromMp3Buffer=function(buffer){reset();_bufferMp3=buffer;window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;var ctx=new AudioContext();var bf=ctx.createBuffer(b.buffer,false);return bf.getChannelData(0);var visualize=function(ctx,bf){var bs=ctx.createBufferSource();var as=ctx.createAnalyser();bs.connect(as);as.connect(ctx.destination);bs.buffer=bf;if(!bs.start){bs.start=bs.noteOn
bs.stop=bs.noteOff}
bs.start(0);this.status=1;this.source=bs;var fd=new Uint8Array(as.frequencyBinCount);as.getByteFrequencyData(fd);var td=new Uint8Array(as.fftSize);as.getByteTimeDomainData(td);return;};ctx.decodeAudioData(b.buffer,function(bf){visualize(ctx,bf);},function(e){alert(e.toString());});_isValid=true;};var toMp3Buffer=function(){return _bufferMp3;};var toImdBuffer=function(){};var toImdText=function(){};this.fromBuffer=function(buffer,type){if(buffer.length==0){return;}
switch(type){case"mp3":fromMp3Buffer(buffer);break;}};this.toBuffer=function(type){switch(type){case"mp3":return toMp3Buffer();break;case"xml":if(typeof _bufferImd==="undefined"){_bufferImd=toImdBuffer();}
return _bufferImd;break;}};this.toText=function(type){switch(type){case"imd":if(typeof _textImd==="undefined"){_textImd=toImdText();}
return _textImd;break;}};this.IsValid=function(){return _isValid;};this.fromBuffer(buffer,type);}</script><script type="text/javascript">var Version="20150619";var FileName;var FileExtension;var FileType;var FileBuffer;var FileData;var SelectCount;(function(){var s=location.search.substring(1).split("&");for(var i=0;i<s.length;i++){var a=s[i].split("=");if(a.length==2){switch(a[0]){case"func":var f=a[1].split(",");for(var j=0;j<f.length;j++){switch(f[j]){case"version":alert("Version = "+Version);break;}}
break;}}}})();function HideOperate(){document.getElementById("divOperateBin").style.display="none";document.getElementById("divOperateXml").style.display="none";document.getElementById("divOperateImd").style.display="none";document.getElementById("divSelectImd").style.display="none";document.getElementById("divOperateImg").style.display="none";document.getElementById("divSave").style.display="none";document.getElementById("divResult").innerHTML="";}
function HideOption(){var Hide=function(t){switch(t){case"png":document.getElementById("divOptionImd1").style.display="block";document.getElementById("divOptionImd2").style.display="block";document.getElementById("divOptionImd3").style.display="none";document.getElementById("divOptionImd4").style.display="block";document.getElementById("divOptionImd5").style.display="block";break;case"html":document.getElementById("divOptionImd1").style.display="block";document.getElementById("divOptionImd2").style.display="block";document.getElementById("divOptionImd3").style.display="block";document.getElementById("divOptionImd4").style.display="block";document.getElementById("divOptionImd5").style.display="block";break;default:document.getElementById("divOptionImd1").style.display="none";document.getElementById("divOptionImd2").style.display="none";document.getElementById("divOptionImd3").style.display="none";document.getElementById("divOptionImd4").style.display="block";document.getElementById("divOptionImd5").style.display="block";}}
Hide(GetSelectValue("selectImdMode"));}
function ShowText(s,d,e,t){if(!IsUCBrowser&&(d.length!=0)){var a=document.getElementById("aSave");a.href=URL.createObjectURL(new Blob([d],{"type":t}));a.download=FileName+"."+e;document.getElementById("divSave").style.display="block";}
if((FileExtension=="bin")&&(d.length==0)){document.getElementById("divOperateBin").style.display="none";document.getElementById("divOperateXml").style.display="none";alert("目前不支持 "+FileName+" 。");return;}
var p=document.createElement("p");p.style.textAlign="left";p.style.fontSize="14px";p.innerHTML=TextToHtml(s).replace(/\r\n/g,"<br/>");document.getElementById("divResult").appendChild(p);}
function ShowBin(s,d,e,t){if(!IsUCBrowser&&(d.length!=0)){var a=document.getElementById("aSave");a.href=URL.createObjectURL(new Blob([d],{"type":t}));a.download=FileName+"."+e;document.getElementById("divSave").style.display="block";}
if(document.getElementById("divSave").style.display=="none"){document.getElementById("divOperateXml").style.display="none";}
var p=document.createElement("p");p.style.textAlign="left";p.style.fontSize="14px";p.innerHTML=TextToHtml(s).replace(/\r\n/g,"<br/>");document.getElementById("divResult").appendChild(p);}
function ShowHtml(d,e,t){if(!IsUCBrowser&&(d.length!=0)){var a=document.getElementById("aSave");a.href=URL.createObjectURL(new Blob([TextToBytes(d)],{"type":t}));a.download=FileName+"."+e;document.getElementById("divSave").style.display="block";}
if((FileExtension=="bin")&&(d.length==0)){document.getElementById("divOperateBin").style.display="none";document.getElementById("divOperateXml").style.display="none";alert("目前不支持 "+FileName+" 。");return;}
var iframe=document.createElement("iframe");iframe.onload=function(){var c=this.contentDocument;if(this!=null&&c!=null){this.style.border="none";this.width="100%";this.height=c.body.scrollHeight+17;this.style.display="block";}};iframe.style.display="none";iframe.src=a.href;document.getElementById("divResult").appendChild(iframe);}
function ShowImg(d,e,t){if(!IsUCBrowser&&(d.length!=0)){var a=document.getElementById("aSave");a.href=URL.createObjectURL(new Blob([Base64ToBytes(d.split(",")[1])],{"type":t}));a.download=FileName+"."+e;document.getElementById("divSave").style.display="block";}
var img=document.createElement("img");img.src=d;document.getElementById("divResult").appendChild(img);}
function ShowAudio(d,e){return;var l=[];for(var i=0;i<100000;i++){if(d[i].toString()!="0"){l.push(d[i].toString()+","+i.toString());}}
alert(l.length);d=l.join("</br>");document.write(d);return;if(!IsUCBrowser&&(d.length!=0)){var a=document.getElementById("aSave");a.href=URL.createObjectURL(new Blob([d],{"type":t}));a.download=FileName+"."+e;document.getElementById("divSave").style.display="block";}
return;}
function ReadBuffer(){switch(FileExtension){case"bin":FileData=new Bin(FileBuffer,"bin");break;case"xml":switch(FileType){case"bin":FileData=new Bin(FileBuffer,"xml");break;case"mde":FileData=new Mde(FileBuffer,"xml");break;}
break;case"mde":FileData=new Mde(FileBuffer,"mde");break;case"imd":FileData=new Imd(FileBuffer,"imd");break;case"txt":FileData=new Imd(FileBuffer,"txt");break;case"bms":case"bme":case"pms":FileData=new Imd(FileBuffer,"bms");break;case"bmp":case"jpg":case"gif":case"png":FileData=new Img(FileBuffer,"img");break;case"mp3":FileData=new Mp3(FileBuffer,"mp3");break;}}
function ReadData(){var e=(arguments.length>0)?arguments[0]:"";HideOperate();switch(FileExtension){case"bin":if(!FileData.IsValid()){return;}
document.getElementById("divOperateBin").style.display="block";switch(GetSelectValue("selectBinMode")){case"xml":ShowText(FileData.toText("xml"),FileData.toBuffer("xml"),"xml","text/html");break;case"html":ShowHtml(FileData.toText("html"),"html","text/html");break;}
break;case"xml":switch(FileType){case"bin":if(!FileData.IsValid()){return;}
document.getElementById("divOperateXml").style.display="block";switch(GetSelectValue("selectXmlbinMode")){case"bin":ShowBin(FileData.toText("xml"),FileData.toBuffer("bin"),"bin","application/octet-binary");break;case"html":ShowHtml(FileData.toText("html"),"html","text/html");break;}
break;case"mde":if(!FileData.IsValid()){return;}
ShowText(FileData.toText("xml"),FileData.toBuffer("mde"),"mde","text/html");break;}
break;case"mde":if(!FileData.IsValid()){return;}
ShowText(FileData.toText("xml"),FileData.toBuffer("xml"),"xml","text/html");break;case"imd":switch(e){case"select":break;case"option":FileData.ReDraw();break;case"check":FileData.fromBuffer(FileBuffer,"imd");break;}
if(!FileData.IsValid()){return;}
document.getElementById("divOperateImd").style.display="block";document.getElementById("divSelectImd").style.display="block";HideOption();switch(GetSelectValue("selectImdMode")){case"png":if(!SupportCanvasAPI){alert("当前浏览器内核不支持Canvas API。");return;}
ShowImg(FileData.toText("png"),"png","image/png");break;case"html":ShowHtml(FileData.toText("html"),"html","text/html");break;case"imd":ShowText(FileData.toText("imd"),FileData.toBuffer("imd"),"imd","application/octet-binary");break;case"txt":ShowText(FileData.toText("txt"),FileData.toBuffer("txt"),"txt","text/plain");break;case"bms":ShowText(FileData.toText("bms"),FileData.toBuffer("bms"),"bms","text/plain");break;}
break;case"txt":switch(e){case"select":break;case"option":FileData.ReDraw();break;case"check":FileData.fromBuffer(FileBuffer,"txt");break;}
if(!FileData.IsValid()){return;}
document.getElementById("divOperateImd").style.display="block";document.getElementById("divSelectImd").style.display="block";HideOption();switch(GetSelectValue("selectImdMode")){case"png":if(!SupportCanvasAPI){alert("当前浏览器内核不支持Canvas API。");return;}
ShowImg(FileData.toText("png"),"png","image/png");break;case"html":ShowHtml(FileData.toText("html"),"html","text/html");break;case"imd":ShowText(FileData.toText("imd"),FileData.toBuffer("imd"),"imd","application/octet-binary");break;case"txt":ShowText(FileData.toText("txt"),FileData.toBuffer("txt"),"txt","text/plain");break;case"bms":ShowText(FileData.toText("bms"),FileData.toBuffer("bms"),"bms","text/plain");break;}
break;case"bms":case"bme":case"pms":switch(e){case"select":break;case"option":FileData.ReDraw();break;case"check":FileData.fromBuffer(FileBuffer,"bms");break;}
if(!FileData.IsValid()){return;}
document.getElementById("divOperateImd").style.display="block";document.getElementById("divSelectImd").style.display="block";HideOption();switch(GetSelectValue("selectImdMode")){case"png":if(!SupportCanvasAPI){alert("当前浏览器内核不支持Canvas API。");return;}
ShowImg(FileData.toText("png"),"png","image/png");break;case"html":ShowHtml(FileData.toText("html"),"html","text/html");break;case"imd":ShowText(FileData.toText("imd"),FileData.toBuffer("imd"),"imd","application/octet-binary");break;case"txt":ShowText(FileData.toText("txt"),FileData.toBuffer("txt"),"txt","text/plain");break;case"bms":ShowText(FileData.toText("bms"),FileData.toBuffer("bms"),"bms","text/plain");break;}
break;case"bmp":case"jpg":case"gif":case"png":if(!FileData.IsValid()){return;}
if(!SupportCanvasAPI){alert("当前浏览器内核不支持Canvas API。");return;}
document.getElementById("divOperateImg").style.display="block";if(SelectCount==0){var v=GetImgSize(FileBuffer);var s=document.getElementById("selectImgMode");for(var i=0;i<s.children.length;i++){if(s.children[i].value==v){s.selectedIndex=i;break;}}}
ShowImg(FileData.toText("png",document.getElementById("selectImgMode").selectedIndex),"png","image/png");break;case"mp3":return;if(!FileData.IsValid()){return;}
if(!SupportCanvasAPI){alert("当前浏览器内核不支持Canvas API。");return;}
if(!SupportAudioAPI){alert("当前浏览器内核不支持Audio API。");return;}
ShowAudio(FileData.toText("imd"),"imd","application/octet-binary");break;}}
function ReadFile(e){if(!SupportFileAPI){alert("当前浏览器内核不支持File API。");return;}
var r=new FileReader();r.onload=function(){FileBuffer=new Uint8Array(this.result);FileType=GetFileType(FileExtension,FileBuffer);SelectCount=0;ReadBuffer();ReadData();};FileName=OptimizeName(GetFileName(e.target.files[0].name));FileExtension=GetFileExtension(e.target.files[0].name);r.readAsArrayBuffer(e.target.files[0]);}
function SelectChanged(){SelectCount+=1;ReadData("select");}
function OptionChanged(){ReadData("option");}
function CheckChanged(){ReadData("check");}</script></body></html>